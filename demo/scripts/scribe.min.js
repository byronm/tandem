function LinkedList(){}window.rangy=function(){function u(n,r){var i=typeof n[r];return i==t||i==e&&!!n[r]||i=="unknown"}function a(t,n){return typeof t[n]==e&&!!t[n]}function f(e,t){return typeof e[t]!=n}function l(e){return function(t,n){var r=n.length;while(r--)if(!e(t,n[r]))return!1;return!0}}function d(e){return e&&c(e,o)&&p(e,s)}function m(e,t){t?window.alert(e):typeof window.console!=n&&typeof window.console.log!=n&&window.console.log(e)}function g(e){v.initialized=!0,v.supported=!1,m("Rangy is not supported on this page in your browser. Reason: "+e,v.config.alertOnFail)}function y(e){m("Rangy warning: "+e,v.config.alertOnWarn)}function E(){if(v.initialized)return;var e,t=!1,n=!1;u(document,"createRange")&&(e=document.createRange(),c(e,i)&&p(e,r)&&(t=!0),e.detach());var s=a(document,"body")?document.body:document.getElementsByTagName("body")[0];if(!s||s.nodeName.toLowerCase()!="body"){g("No body element found");return}s&&u(s,"createTextRange")&&(e=s.createTextRange(),d(e)&&(n=!0));if(!t&&!n){g("Neither Range nor TextRange are available");return}v.initialized=!0,v.features={implementsDomRange:t,implementsTextRange:n};var o=w.concat(b);for(var f=0,l=o.length;f<l;++f)try{o[f](v)}catch(h){a(window,"console")&&u(window.console,"log")&&window.console.log("Rangy init listener threw an exception. Continuing.",h)}}function x(e){e=e||window,E();for(var t=0,n=S.length;t<n;++t)S[t](e)}function T(e){this.name=e,this.initialized=!1,this.supported=!1}var e="object",t="function",n="undefined",r=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer"],i=["setStart","setStartBefore","setStartAfter","setEnd","setEndBefore","setEndAfter","collapse","selectNode","selectNodeContents","compareBoundaryPoints","deleteContents","extractContents","cloneContents","insertNode","surroundContents","cloneRange","toString","detach"],s=["boundingHeight","boundingLeft","boundingTop","boundingWidth","htmlText","text"],o=["collapse","compareEndPoints","duplicate","moveToElementText","parentElement","select","setEndPoint","getBoundingClientRect"],c=l(u),h=l(a),p=l(f),v={version:"1.3alpha.681",initialized:!1,supported:!0,util:{isHostMethod:u,isHostObject:a,isHostProperty:f,areHostMethods:c,areHostObjects:h,areHostProperties:p,isTextRange:d},features:{},modules:{},config:{alertOnFail:!0,alertOnWarn:!1,preferTextRange:!1}};v.fail=g,v.warn=y,{}.hasOwnProperty?v.util.extend=function(e,t,n){var r,i;for(var s in t)t.hasOwnProperty(s)&&(r=e[s],i=t[s],n&&r!==null&&typeof r=="object"&&i!==null&&typeof i=="object"&&v.util.extend(r,i,!0),e[s]=i);return e}:g("hasOwnProperty not supported");var b=[],w=[];v.init=E,v.addInitListener=function(e){v.initialized?e(v):b.push(e)};var S=[];v.addCreateMissingNativeApiListener=function(e){S.push(e)},v.createMissingNativeApi=x,T.prototype={fail:function(e){throw this.initialized=!0,this.supported=!1,new Error("Module '"+this.name+"' failed to load: "+e)},warn:function(e){v.warn("Module "+this.name+": "+e)},deprecationNotice:function(e,t){v.warn("DEPRECATED: "+e+" in module "+this.name+"is deprecated. Please use "+t+" instead")},createError:function(e){return new Error("Error in Rangy "+this.name+" module: "+e)}},v.createModule=function(e,t){var n=new T(e);v.modules[e]=n,w.push(function(e){t(e,n),n.initialized=!0,n.supported=!0})},v.requireModules=function(e){for(var t=0,n=e.length,r,i;t<n;++t){i=e[t],r=v.modules[i];if(!r||!(r instanceof T))throw new Error("Module '"+i+"' not found");if(!r.supported)throw new Error("Module '"+i+"' not supported")}};var N=!1,C=function(e){N||(N=!0,v.initialized||E())};if(typeof window==n){g("No window found");return}if(typeof document==n){g("No document found");return}return u(document,"addEventListener")&&document.addEventListener("DOMContentLoaded",C,!1),u(window,"addEventListener")?window.addEventListener("load",C,!1):u(window,"attachEvent")?window.attachEvent("onload",C):g("Window does not have required addEventListener or attachEvent method"),v}(),rangy.createModule("DomUtil",function(e,t){function u(e){var t;return typeof e.namespaceURI==n||(t=e.namespaceURI)===null||t=="http://www.w3.org/1999/xhtml"}function a(e){var t=e.parentNode;return t.nodeType==1?t:null}function f(e){var t=0;while(e=e.previousSibling)t++;return t}function l(e){switch(e.nodeType){case 7:case 10:return 0;case 3:case 8:return e.length;default:return e.childNodes.length}}function c(e,t){var n=[],r;for(r=e;r;r=r.parentNode)n.push(r);for(r=t;r;r=r.parentNode)if(o(n,r))return r;return null}function h(e,t,n){var r=n?t:t.parentNode;while(r){if(r===e)return!0;r=r.parentNode}return!1}function p(e,t){return h(e,t,!0)}function d(e,t,n){var r,i=n?e:e.parentNode;while(i){r=i.parentNode;if(r===t)return i;i=r}return null}function v(e){var t=e.nodeType;return t==3||t==4||t==8}function m(e){if(!e)return!1;var t=e.nodeType;return t==3||t==8}function g(e,t){var n=t.nextSibling,r=t.parentNode;return n?r.insertBefore(e,n):r.appendChild(e),e}function y(e,t,n){var r=e.cloneNode(!1);r.deleteData(0,t),e.deleteData(t,e.length-t),g(r,e);if(n)for(var i=0,s;s=n[i++];)s.node==e&&s.offset>t?(s.node=r,s.offset-=t):s.node==e.parentNode&&s.offset>f(e)&&++s.offset;return r}function b(e){if(e.nodeType==9)return e;if(typeof e.ownerDocument!=n)return e.ownerDocument;if(typeof e.document!=n)return e.document;if(e.parentNode)return b(e.parentNode);throw t.createError("getDocument: no document found for node")}function w(e){var r=b(e);if(typeof r.defaultView!=n)return r.defaultView;if(typeof r.parentWindow!=n)return r.parentWindow;throw t.createError("Cannot get a window object for node")}function E(e){if(typeof e.contentDocument!=n)return e.contentDocument;if(typeof e.contentWindow!=n)return e.contentWindow.document;throw t.createError("getIframeDocument: No Document object found for iframe element")}function S(e){if(typeof e.contentWindow!=n)return e.contentWindow;if(typeof e.contentDocument!=n)return e.contentDocument.defaultView;throw t.createError("getIframeWindow: No Window object found for iframe element")}function x(e){return r.isHostObject(e,"body")?e.body:e.getElementsByTagName("body")[0]}function T(e){return e&&r.isHostMethod(e,"setTimeout")&&r.isHostObject(e,"document")}function N(e){var t;return e?r.isHostProperty(e,"nodeType")?t=e.nodeType==1&&e.tagName.toLowerCase()=="iframe"?E(e):b(e):T(e)&&(t=e.document):t=document,t}function C(e){var t;while(t=e.parentNode)e=t;return e}function k(e,n,r,i){var s,o,u,a,l;if(e==r)return n===i?0:n<i?-1:1;if(s=d(r,e,!0))return n<=f(s)?-1:1;if(s=d(e,r,!0))return f(s)<i?-1:1;o=c(e,r),u=e===o?o:d(e,o,!0),a=r===o?o:d(r,o,!0);if(u===a)throw t.createError("comparePoints got to case 4 and childA and childB are the same!");l=o.firstChild;while(l){if(l===u)return-1;if(l===a)return 1;l=l.nextSibling}}function L(e){if(!e)return"[No node]";if(v(e))return'"'+e.data+'"';if(e.nodeType==1){var t=e.id?' id="'+e.id+'"':"";return"<"+e.nodeName+t+">["+e.childNodes.length+"]"}return e.nodeName}function A(e){var t=b(e).createDocumentFragment(),n;while(n=e.firstChild)t.appendChild(n);return t}function O(e){this.root=e,this._next=e}function M(e){return new O(e)}function _(e,t){this.node=e,this.offset=t}function D(e){this.code=this[e],this.codeName=e,this.message="DOMException: "+this.codeName}var n="undefined",r=e.util;r.areHostMethods(document,["createDocumentFragment","createElement","createTextNode"])||t.fail("document missing a Node creation method"),r.isHostMethod(document,"getElementsByTagName")||t.fail("document missing getElementsByTagName method");var i=document.createElement("div");r.areHostMethods(i,["insertBefore","appendChild","cloneNode"]||!r.areHostObjects(i,["previousSibling","nextSibling","childNodes","parentNode"]))||t.fail("Incomplete Element implementation"),r.isHostProperty(i,"innerHTML")||t.fail("Element is missing innerHTML property");var s=document.createTextNode("test");r.areHostMethods(s,["splitText","deleteData","insertData","appendData","cloneNode"]||!r.areHostObjects(i,["previousSibling","nextSibling","childNodes","parentNode"])||!r.areHostProperties(s,["data"]))||t.fail("Incomplete Text Node implementation");var o=function(e,t){var n=e.length;while(n--)if(e[n]===t)return!0;return!1};O.prototype={_current:null,hasNext:function(){return!!this._next},next:function(){var e=this._current=this._next,t,n;if(this._current){t=e.firstChild;if(t)this._next=t;else{n=null;while(e!==this.root&&!(n=e.nextSibling))e=e.parentNode;this._next=n}}return this._current},detach:function(){this._current=this._next=this.root=null}},_.prototype={equals:function(e){return!!e&&this.node===e.node&&this.offset==e.offset},inspect:function(){return"[DomPosition("+L(this.node)+":"+this.offset+")]"},toString:function(){return this.inspect()}},D.prototype={INDEX_SIZE_ERR:1,HIERARCHY_REQUEST_ERR:3,WRONG_DOCUMENT_ERR:4,NO_MODIFICATION_ALLOWED_ERR:7,NOT_FOUND_ERR:8,NOT_SUPPORTED_ERR:9,INVALID_STATE_ERR:11},D.prototype.toString=function(){return this.message},e.dom={arrayContains:o,isHtmlNamespace:u,parentElement:a,getNodeIndex:f,getNodeLength:l,getCommonAncestor:c,isAncestorOf:h,isOrIsAncestorOf:p,getClosestAncestorIn:d,isCharacterDataNode:v,isTextOrCommentNode:m,insertAfter:g,splitDataNode:y,getDocument:b,getWindow:w,getIframeWindow:S,getIframeDocument:E,getBody:x,isWindow:T,getContentDocument:N,getRootContainer:C,comparePoints:k,inspectNode:L,fragmentFromNodeChildren:A,createIterator:M,DomPosition:_},e.DOMException=D}),rangy.createModule("DomRange",function(e,t){function o(e,t){return e.nodeType!=3&&(n.isOrIsAncestorOf(e,t.startContainer)||n.isOrIsAncestorOf(e,t.endContainer))}function u(e){return n.getDocument(e.startContainer)}function a(e){return new i(e.parentNode,n.getNodeIndex(e))}function f(e){return new i(e.parentNode,n.getNodeIndex(e)+1)}function l(e,t,r){var i=e.nodeType==11?e.firstChild:e;return n.isCharacterDataNode(t)?r==t.length?n.insertAfter(e,t):t.parentNode.insertBefore(e,r==0?t:n.splitDataNode(t,r)):r>=t.childNodes.length?t.appendChild(e):t.insertBefore(e,t.childNodes[r]),i}function c(e,t,r){q(e),q(t);if(u(t)!=u(e))throw new s("WRONG_DOCUMENT_ERR");var i=n.comparePoints(e.startContainer,e.startOffset,t.endContainer,t.endOffset),o=n.comparePoints(e.endContainer,e.endOffset,t.startContainer,t.startOffset);return r?i<=0&&o>=0:i<0&&o>0}function h(e){var t;for(var n,r=u(e.range).createDocumentFragment(),i;n=e.next();){t=e.isPartiallySelectedSubtree(),n=n.cloneNode(!t),t&&(i=e.getSubtreeIterator(),n.appendChild(h(i)),i.detach(!0));if(n.nodeType==10)throw new s("HIERARCHY_REQUEST_ERR");r.appendChild(n)}return r}function p(e,t,r){var i,s;r=r||{stop:!1};for(var o,u;o=e.next();)if(e.isPartiallySelectedSubtree()){if(t(o)===!1){r.stop=!0;return}u=e.getSubtreeIterator(),p(u,t,r),u.detach(!0);if(r.stop)return}else{i=n.createIterator(o);while(s=i.next())if(t(s)===!1){r.stop=!0;return}}}function d(e){var t;while(e.next())e.isPartiallySelectedSubtree()?(t=e.getSubtreeIterator(),d(t),t.detach(!0)):e.remove()}function v(e){for(var t,n=u(e.range).createDocumentFragment(),r;t=e.next();){e.isPartiallySelectedSubtree()?(t=t.cloneNode(!1),r=e.getSubtreeIterator(),t.appendChild(v(r)),r.detach(!0)):e.remove();if(t.nodeType==10)throw new s("HIERARCHY_REQUEST_ERR");n.appendChild(t)}return n}function m(e,t,n){var r=!!t&&!!t.length,i,s=!!n;r&&(i=new RegExp("^("+t.join("|")+")$"));var o=[];return p(new y(e,!1),function(e){(!r||i.test(e.nodeType))&&(!s||n(e))&&o.push(e)}),o}function g(e){var t=typeof e.getName=="undefined"?"Range":e.getName();return"["+t+"("+n.inspectNode(e.startContainer)+":"+e.startOffset+", "+n.inspectNode(e.endContainer)+":"+e.endOffset+")]"}function y(e,t){this.range=e,this.clonePartiallySelectedTextNodes=t;if(!e.collapsed){this.sc=e.startContainer,this.so=e.startOffset,this.ec=e.endContainer,this.eo=e.endOffset;var r=e.commonAncestorContainer;this.sc===this.ec&&n.isCharacterDataNode(this.sc)?(this.isSingleCharacterDataNode=!0,this._first=this._last=this._next=this.sc):(this._first=this._next=this.sc===r&&!n.isCharacterDataNode(this.sc)?this.sc.childNodes[this.so]:n.getClosestAncestorIn(this.sc,r,!0),this._last=this.ec===r&&!n.isCharacterDataNode(this.ec)?this.ec.childNodes[this.eo-1]:n.getClosestAncestorIn(this.ec,r,!0))}}function b(e){this.code=this[e],this.codeName=e,this.message="RangeException: "+this.codeName}function N(e){return function(t,r){var i,s=r?t:t.parentNode;while(s){i=s.nodeType;if(n.arrayContains(e,i))return s;s=s.parentNode}return null}}function O(e,t){if(A(e,t))throw new b("INVALID_NODE_TYPE_ERR")}function M(e){if(!e.startContainer)throw new s("INVALID_STATE_ERR")}function _(e,t){if(!n.arrayContains(t,e.nodeType))throw new b("INVALID_NODE_TYPE_ERR")}function D(e,t){if(t<0||t>(n.isCharacterDataNode(e)?e.length:e.childNodes.length))throw new s("INDEX_SIZE_ERR")}function P(e,t){if(k(e,!0)!==k(t,!0))throw new s("WRONG_DOCUMENT_ERR")}function H(e){if(L(e,!0))throw new s("NO_MODIFICATION_ALLOWED_ERR")}function B(e,t){if(!e)throw new s(t)}function j(e){return!n.arrayContains(E,e.nodeType)&&!k(e,!0)}function F(e,t){return t<=(n.isCharacterDataNode(e)?e.length:e.childNodes.length)}function I(e){return!!e.startContainer&&!!e.endContainer&&!j(e.startContainer)&&!j(e.endContainer)&&F(e.startContainer,e.startOffset)&&F(e.endContainer,e.endOffset)}function q(e){M(e);if(!I(e))throw new Error("Range error: Range is no longer valid after DOM mutation ("+e.inspect()+")")}function X(e,t){q(e);var r=e.startContainer,i=e.startOffset,s=e.endContainer,o=e.endOffset,u=r===s;n.isCharacterDataNode(s)&&o>0&&o<s.length&&n.splitDataNode(s,o,t),n.isCharacterDataNode(r)&&i>0&&i<r.length&&(r=n.splitDataNode(r,i,t),u?(o-=i,s=r):s==r.parentNode&&o>=n.getNodeIndex(r)&&o++,i=0),e.setStartAndEnd(r,i,s,o)}function tt(){}function nt(e){e.START_TO_START=$,e.START_TO_END=J,e.END_TO_END=K,e.END_TO_START=Q,e.NODE_BEFORE=G,e.NODE_AFTER=Y,e.NODE_BEFORE_AND_AFTER=Z,e.NODE_INSIDE=et}function rt(e){nt(e),nt(e.prototype)}function it(e,t){return function(){q(this);var r=this.startContainer,i=this.startOffset,s=this.commonAncestorContainer,o=new y(this,!0),u,a;r!==s&&(u=n.getClosestAncestorIn(r,s,!0),a=f(u),r=a.node,i=a.offset),p(o,H),o.reset();var l=e(o);return o.detach(),t(this,r,i,r,i),l}}function st(e,t,i){function s(e,t){return function(n){M(this),_(n,w),_(C(n),E);var r=(e?a:f)(n);(t?u:l)(this,r.node,r.offset)}}function u(e,r,i){var s=e.endContainer,o=e.endOffset;if(r!==e.startContainer||i!==e.startOffset){if(C(r)!=C(s)||n.comparePoints(r,i,s,o)==1)s=r,o=i;t(e,r,i,s,o)}}function l(e,r,i){var s=e.startContainer,o=e.startOffset;if(r!==e.endContainer||i!==e.endOffset){if(C(r)!=C(s)||n.comparePoints(r,i,s,o)==-1)s=r,o=i;t(e,s,o,r,i)}}e.prototype=new tt,r.extend(e.prototype,{setStart:function(e,t){M(this),O(e,!0),D(e,t),u(this,e,t)},setEnd:function(e,t){M(this),O(e,!0),D(e,t),l(this,e,t)},setStartAndEnd:function(){M(this);var e=arguments,n=e[0],r=e[1],i=n,s=r;switch(e.length){case 3:s=e[2];break;case 4:i=e[2],s=e[3]}t(this,n,r,i,s)},setStartBefore:s(!0,!0),setStartAfter:s(!1,!0),setEndBefore:s(!0,!1),setEndAfter:s(!1,!1),collapse:function(e){q(this),e?t(this,this.startContainer,this.startOffset,this.startContainer,this.startOffset):t(this,this.endContainer,this.endOffset,this.endContainer,this.endOffset)},selectNodeContents:function(e){M(this),O(e,!0),t(this,e,0,e,n.getNodeLength(e))},selectNode:function(e){M(this),O(e,!1),_(e,w);var n=a(e),r=f(e);t(this,n.node,n.offset,r.node,r.offset)},extractContents:it(v,t),deleteContents:it(d,t),canSurroundContents:function(){q(this),H(this.startContainer),H(this.endContainer);var e=new y(this,!0),t=e._first&&o(e._first,this)||e._last&&o(e._last,this);return e.detach(),!t},detach:function(){i(this)},splitBoundaries:function(){X(this)},splitBoundariesPreservingPositions:function(e){X(this,e)},normalizeBoundaries:function(){q(this);var e=this.startContainer,r=this.startOffset,i=this.endContainer,s=this.endOffset,o=function(e){var t=e.nextSibling;t&&t.nodeType==e.nodeType&&(i=e,s=e.length,e.appendData(t.data),t.parentNode.removeChild(t))},u=function(t){var o=t.previousSibling;if(o&&o.nodeType==t.nodeType){e=t;var u=t.length;r=o.length,t.insertData(0,o.data),o.parentNode.removeChild(o);if(e==i)s+=r,i=e;else if(i==t.parentNode){var a=n.getNodeIndex(t);s==a?(i=t,s=u):s>a&&s--}}},a=!0;if(n.isCharacterDataNode(i))i.length==s&&o(i);else{if(s>0){var f=i.childNodes[s-1];f&&n.isCharacterDataNode(f)&&o(f)}a=!this.collapsed}if(a){if(n.isCharacterDataNode(e))r==0&&u(e);else if(r<e.childNodes.length){var l=e.childNodes[r];l&&n.isCharacterDataNode(l)&&u(l)}}else e=i,r=s;t(this,e,r,i,s)},collapseToPoint:function(e,t){M(this),O(e,!0),D(e,t),this.setStartAndEnd(e,t)}}),rt(e)}function ot(e){e.collapsed=e.startContainer===e.endContainer&&e.startOffset===e.endOffset,e.commonAncestorContainer=e.collapsed?e.startContainer:n.getCommonAncestor(e.startContainer,e.endContainer)}function ut(e,t,n,r,i){e.startContainer=t,e.startOffset=n,e.endContainer=r,e.endOffset=i,ot(e)}function at(e){M(e),e.startContainer=e.startOffset=e.endContainer=e.endOffset=null,e.collapsed=e.commonAncestorContainer=null}function ft(e){this.startContainer=e,this.startOffset=0,this.endContainer=e,this.endOffset=0,ot(this)}e.requireModules(["DomUtil"]);var n=e.dom,r=e.util,i=n.DomPosition,s=e.DOMException;y.prototype={_current:null,_next:null,_first:null,_last:null,isSingleCharacterDataNode:!1,reset:function(){this._current=null,this._next=this._first},hasNext:function(){return!!this._next},next:function(){var e=this._current=this._next;return e&&(this._next=e!==this._last?e.nextSibling:null,n.isCharacterDataNode(e)&&this.clonePartiallySelectedTextNodes&&(e===this.ec&&(e=e.cloneNode(!0)).deleteData(this.eo,e.length-this.eo),this._current===this.sc&&(e=e.cloneNode(!0)).deleteData(0,this.so))),e},remove:function(){var e=this._current,t,r;!n.isCharacterDataNode(e)||e!==this.sc&&e!==this.ec?e.parentNode&&e.parentNode.removeChild(e):(t=e===this.sc?this.so:0,r=e===this.ec?this.eo:e.length,t!=r&&e.deleteData(t,r-t))},isPartiallySelectedSubtree:function(){var e=this._current;return o(e,this.range)},getSubtreeIterator:function(){var e;if(this.isSingleCharacterDataNode)e=this.range.cloneRange(),e.collapse(!1);else{e=new ft(u(this.range));var t=this._current,r=t,i=0,s=t,o=n.getNodeLength(t);n.isOrIsAncestorOf(t,this.sc)&&(r=this.sc,i=this.so),n.isOrIsAncestorOf(t,this.ec)&&(s=this.ec,o=this.eo),ut(e,r,i,s,o)}return new y(e,this.clonePartiallySelectedTextNodes)},detach:function(e){e&&this.range.detach(),this.range=this._current=this._next=this._first=this._last=this.sc=this.so=this.ec=this.eo=null}},b.prototype={BAD_BOUNDARYPOINTS_ERR:1,INVALID_NODE_TYPE_ERR:2},b.prototype.toString=function(){return this.message};var w=[1,3,4,5,7,8,10],E=[2,9,11],S=[5,6,10,12],x=[1,3,4,5,7,8,10,11],T=[1,3,4,5,7,8],C=n.getRootContainer,k=N([9,11]),L=N(S),A=N([6,10,12]),R=document.createElement("style"),U=!1;try{R.innerHTML="<b>x</b>",U=R.firstChild.nodeType==3}catch(z){}e.features.htmlParsingConforms=U;var W=U?function(e){var t=this.startContainer,r=n.getDocument(t);if(!t)throw new s("INVALID_STATE_ERR");var i=null;return t.nodeType==1?i=t:n.isCharacterDataNode(t)&&(i=n.parentElement(t)),i===null||i.nodeName=="HTML"&&n.isHtmlNamespace(n.getDocument(i).documentElement)&&n.isHtmlNamespace(i)?i=r.createElement("body"):i=i.cloneNode(!1),i.innerHTML=e,n.fragmentFromNodeChildren(i)}:function(e){M(this);var t=u(this),r=t.createElement("body");return r.innerHTML=e,n.fragmentFromNodeChildren(r)},V=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer"],$=0,J=1,K=2,Q=3,G=0,Y=1,Z=2,et=3;tt.prototype={compareBoundaryPoints:function(e,t){q(this),P(this.startContainer,t.startContainer);var r,i,s,o,u=e==Q||e==$?"start":"end",a=e==J||e==$?"start":"end";return r=this[u+"Container"],i=this[u+"Offset"],s=t[a+"Container"],o=t[a+"Offset"],n.comparePoints(r,i,s,o)},insertNode:function(e){q(this),_(e,x),H(this.startContainer);if(n.isOrIsAncestorOf(e,this.startContainer))throw new s("HIERARCHY_REQUEST_ERR");var t=l(e,this.startContainer,this.startOffset);this.setStartBefore(t)},cloneContents:function(){q(this);var e,t;if(this.collapsed)return u(this).createDocumentFragment();if(this.startContainer===this.endContainer&&n.isCharacterDataNode(this.startContainer))return e=this.startContainer.cloneNode(!0),e.data=e.data.slice(this.startOffset,this.endOffset),t=u(this).createDocumentFragment(),t.appendChild(e),t;var r=new y(this,!0);return e=h(r),r.detach(),e},canSurroundContents:function(){q(this),H(this.startContainer),H(this.endContainer);var e=new y(this,!0),t=e._first&&o(e._first,this)||e._last&&o(e._last,this);return e.detach(),!t},surroundContents:function(e){_(e,T);if(!this.canSurroundContents())throw new b("BAD_BOUNDARYPOINTS_ERR");var t=this.extractContents();if(e.hasChildNodes())while(e.lastChild)e.removeChild(e.lastChild);l(e,this.startContainer,this.startOffset),e.appendChild(t),this.selectNode(e)},cloneRange:function(){q(this);var e=new ft(u(this)),t=V.length,n;while(t--)n=V[t],e[n]=this[n];return e},toString:function(){q(this);var e=this.startContainer;if(e===this.endContainer&&n.isCharacterDataNode(e))return e.nodeType==3||e.nodeType==4?e.data.slice(this.startOffset,this.endOffset):"";var t=[],r=new y(this,!0);return p(r,function(e){(e.nodeType==3||e.nodeType==4)&&t.push(e.data)}),r.detach(),t.join("")},compareNode:function(e){q(this);var t=e.parentNode,r=n.getNodeIndex(e);if(!t)throw new s("NOT_FOUND_ERR");var i=this.comparePoint(t,r),o=this.comparePoint(t,r+1);return i<0?o>0?Z:G:o>0?Y:et},comparePoint:function(e,t){return q(this),B(e,"HIERARCHY_REQUEST_ERR"),P(e,this.startContainer),n.comparePoints(e,t,this.startContainer,this.startOffset)<0?-1:n.comparePoints(e,t,this.endContainer,this.endOffset)>0?1:0},createContextualFragment:W,toHtml:function(){q(this);var e=this.commonAncestorContainer.parentNode.cloneNode(!1);return e.appendChild(this.cloneContents()),e.innerHTML},intersectsNode:function(e,t){q(this),B(e,"NOT_FOUND_ERR");if(n.getDocument(e)!==u(this))return!1;var r=e.parentNode,i=n.getNodeIndex(e);B(r,"NOT_FOUND_ERR");var s=n.comparePoints(r,i,this.endContainer,this.endOffset),o=n.comparePoints(r,i+1,this.startContainer,this.startOffset);return t?s<=0&&o>=0:s<0&&o>0},isPointInRange:function(e,t){return q(this),B(e,"HIERARCHY_REQUEST_ERR"),P(e,this.startContainer),n.comparePoints(e,t,this.startContainer,this.startOffset)>=0&&n.comparePoints(e,t,this.endContainer,this.endOffset)<=0},intersectsRange:function(e){return c(this,e,!1)},intersectsOrTouchesRange:function(e){return c(this,e,!0)},intersection:function(e){if(this.intersectsRange(e)){var t=n.comparePoints(this.startContainer,this.startOffset,e.startContainer,e.startOffset),r=n.comparePoints(this.endContainer,this.endOffset,e.endContainer,e.endOffset),i=this.cloneRange();return t==-1&&i.setStart(e.startContainer,e.startOffset),r==1&&i.setEnd(e.endContainer,e.endOffset),i}return null},union:function(e){if(this.intersectsOrTouchesRange(e)){var t=this.cloneRange();return n.comparePoints(e.startContainer,e.startOffset,this.startContainer,this.startOffset)==-1&&t.setStart(e.startContainer,e.startOffset),n.comparePoints(e.endContainer,e.endOffset,this.endContainer,this.endOffset)==1&&t.setEnd(e.endContainer,e.endOffset),t}throw new b("Ranges do not intersect")},containsNode:function(e,t){return t?this.intersectsNode(e,!1):this.compareNode(e)==et},containsNodeContents:function(e){return this.comparePoint(e,0)>=0&&this.comparePoint(e,n.getNodeLength(e))<=0},containsRange:function(e){var t=this.intersection(e);return t!==null&&e.equals(t)},containsNodeText:function(e){var t=this.cloneRange();t.selectNode(e);var n=t.getNodes([3]);if(n.length>0){t.setStart(n[0],0);var r=n.pop();t.setEnd(r,r.length);var i=this.containsRange(t);return t.detach(),i}return this.containsNodeContents(e)},getNodes:function(e,t){return q(this),m(this,e,t)},getDocument:function(){return u(this)},collapseBefore:function(e){M(this),this.setEndBefore(e),this.collapse(!1)},collapseAfter:function(e){M(this),this.setStartAfter(e),this.collapse(!0)},getName:function(){return"DomRange"},equals:function(e){return ft.rangesEqual(this,e)},isValid:function(){return I(this)},inspect:function(){return g(this)}},st(ft,ut,at),e.rangePrototype=tt.prototype,r.extend(ft,{rangeProperties:V,RangeIterator:y,copyComparisonConstants:rt,createPrototypeRange:st,inspect:g,getRangeDocument:u,rangesEqual:function(e,t){return e.startContainer===t.startContainer&&e.startOffset===t.startOffset&&e.endContainer===t.endContainer&&e.endOffset===t.endOffset}}),e.DomRange=ft,e.RangeException=b}),rangy.createModule("WrappedRange",function(e,t){function u(e,n){e=r.getContentDocument(e);if(!e)throw t.createError(n+"(): Parameter must be a Document or other DOM node, or a Window object");return e}function a(e){var t=e.parentElement(),n=e.duplicate();n.collapse(!0);var i=n.parentElement();n=e.duplicate(),n.collapse(!1);var s=n.parentElement(),o=i==s?i:r.getCommonAncestor(i,s);return o==t?o:r.getCommonAncestor(t,o)}function f(e){return e.compareEndPoints("StartToEnd",e)==0}function l(e,t,n,i,o){var u=e.duplicate();u.collapse(n);var a=u.parentElement();r.isOrIsAncestorOf(t,a)||(a=t);if(!a.canHaveHTML)return new s(a.parentNode,r.getNodeIndex(a));var f=r.getDocument(a).createElement("span");f.parentNode&&f.parentNode.removeChild(f);var l,c=n?"StartToStart":"StartToEnd",h,p,d,v,m=o&&o.containerElement==a?o.nodeIndex:0,g=a.childNodes.length,y=g,b=y;for(;;){b==g?a.appendChild(f):a.insertBefore(f,a.childNodes[b]),u.moveToElementText(f),l=u.compareEndPoints(c,e);if(l==0||m==y)break;if(l==-1){if(y==m+1)break;m=b}else y=y==m+1?m:b;b=Math.floor((m+y)/2),a.removeChild(f)}v=f.nextSibling;if(l==-1&&v&&r.isCharacterDataNode(v)){u.setEndPoint(n?"EndToStart":"EndToEnd",e);var w;if(/[\r\n]/.test(v.data)){var E=u.duplicate(),S=E.text.replace(/\r\n/g,"\r").length;w=E.moveStart("character",S);while((l=E.compareEndPoints("StartToEnd",E))==-1)w++,E.moveStart("character",1)}else w=u.text.length;d=new s(v,w)}else h=(i||!n)&&f.previousSibling,p=(i||n)&&f.nextSibling,p&&r.isCharacterDataNode(p)?d=new s(p,0):h&&r.isCharacterDataNode(h)?d=new s(h,h.data.length):d=new s(a,r.getNodeIndex(f));return f.parentNode.removeChild(f),{boundaryPosition:d,nodeInfo:{nodeIndex:b,containerElement:a}}}function c(e,t){var n,i,s=e.offset,o=r.getDocument(e.node),u,a,f=o.body.createTextRange(),l=r.isCharacterDataNode(e.node);return l?(n=e.node,i=n.parentNode):(a=e.node.childNodes,n=s<a.length?a[s]:null,i=e.node),u=o.createElement("span"),u.innerHTML="&#feff;",n?i.insertBefore(u,n):i.appendChild(u),f.moveToElementText(u),f.collapse(!t),i.removeChild(u),l&&f[t?"moveStart":"moveEnd"]("character",s),f}e.requireModules(["DomUtil","DomRange"]);var n,r=e.dom,i=e.util,s=r.DomPosition,o=e.DomRange;if(e.features.implementsDomRange&&(!e.features.implementsTextRange||!e.config.preferTextRange))(function(){function u(e){var t=s.length,n;while(t--)n=s[t],e[n]=e.nativeRange[n];e.collapsed=e.startContainer===e.endContainer&&e.startOffset===e.endOffset}function a(e,t,n,r,i){var s=e.startContainer!==t||e.startOffset!=n,o=e.endContainer!==r||e.endOffset!=i,u=!e.equals(e.nativeRange);if(s||o||u)e.setEnd(r,i),e.setStart(t,n)}function f(e){e.nativeRange.detach(),e.detached=!0;var t=s.length,n;while(t--)n=s[t],e[n]=null}var e,s=o.rangeProperties,l;n=function(e){if(!e)throw t.createError("WrappedRange: Range must be specified");this.nativeRange=e,u(this)},o.createPrototypeRange(n,a,f),e=n.prototype,e.selectNode=function(e){this.nativeRange.selectNode(e),u(this)},e.cloneContents=function(){return this.nativeRange.cloneContents()},e.surroundContents=function(e){this.nativeRange.surroundContents(e),u(this)},e.collapse=function(e){this.nativeRange.collapse(e),u(this)},e.cloneRange=function(){return new n(this.nativeRange.cloneRange())},e.refresh=function(){u(this)},e.toString=function(){return this.nativeRange.toString()};var c=document.createTextNode("test");r.getBody(document).appendChild(c);var h=document.createRange();h.setStart(c,0),h.setEnd(c,0);try{h.setStart(c,1),e.setStart=function(e,t){this.nativeRange.setStart(e,t),u(this)},e.setEnd=function(e,t){this.nativeRange.setEnd(e,t),u(this)},l=function(e){return function(t){this.nativeRange[e](t),u(this)}}}catch(p){e.setStart=function(e,t){try{this.nativeRange.setStart(e,t)}catch(n){this.nativeRange.setEnd(e,t),this.nativeRange.setStart(e,t)}u(this)},e.setEnd=function(e,t){try{this.nativeRange.setEnd(e,t)}catch(n){this.nativeRange.setStart(e,t),this.nativeRange.setEnd(e,t)}u(this)},l=function(e,t){return function(n){try{this.nativeRange[e](n)}catch(r){this.nativeRange[t](n),this.nativeRange[e](n)}u(this)}}}e.setStartBefore=l("setStartBefore","setEndBefore"),e.setStartAfter=l("setStartAfter","setEndAfter"),e.setEndBefore=l("setEndBefore","setStartBefore"),e.setEndAfter=l("setEndAfter","setStartAfter"),h.selectNodeContents(c),h.startContainer==c&&h.endContainer==c&&h.startOffset==0&&h.endOffset==c.length?e.selectNodeContents=function(e){this.nativeRange.selectNodeContents(e),u(this)}:e.selectNodeContents=function(e){this.setStart(e,0),this.setEnd(e,o.getEndOffset(e))},h.selectNodeContents(c),h.setEnd(c,3);var d=document.createRange();d.selectNodeContents(c),d.setEnd(c,4),d.setStart(c,2),h.compareBoundaryPoints(h.START_TO_END,d)==-1&&h.compareBoundaryPoints(h.END_TO_START,d)==1?e.compareBoundaryPoints=function(e,t){return t=t.nativeRange||t,e==t.START_TO_END?e=t.END_TO_START:e==t.END_TO_START&&(e=t.START_TO_END),this.nativeRange.compareBoundaryPoints(e,t)}:e.compareBoundaryPoints=function(e,t){return this.nativeRange.compareBoundaryPoints(e,t.nativeRange||t)};var v=document.createElement("div");v.innerHTML="123";var m=v.firstChild;document.body.appendChild(v),h.setStart(m,1),h.setEnd(m,2),h.deleteContents(),m.data=="13"&&(e.deleteContents=function(){this.nativeRange.deleteContents(),u(this)},e.extractContents=function(){var e=this.nativeRange.extractContents();return u(this),e}),document.body.removeChild(v),i.isHostMethod(h,"createContextualFragment")&&(e.createContextualFragment=function(e){return this.nativeRange.createContextualFragment(e)}),r.getBody(document).removeChild(c),h.detach(),d.detach()})(),e.createNativeRange=function(e){return e=u(e,"createNativeRange"),e.createRange()};else if(e.features.implementsTextRange){n=function(e){this.textRange=e,this.refresh()},n.prototype=new o(document),n.prototype.refresh=function(){var e,t,n,r=a(this.textRange);f(this.textRange)?t=e=l(this.textRange,r,!0,!0).boundaryPosition:(n=l(this.textRange,r,!0,!1),e=n.boundaryPosition,t=l(this.textRange,r,!1,!1,n.nodeInfo).boundaryPosition),this.setStart(e.node,e.offset),this.setEnd(t.node,t.offset)},o.copyComparisonConstants(n);var h=function(){return this}();typeof h.Range=="undefined"&&(h.Range=n),e.createNativeRange=function(e){return e=u(e,"createNativeRange"),e.body.createTextRange()}}e.features.implementsTextRange&&(n.rangeToTextRange=function(e){if(e.collapsed)return c(new s(e.startContainer,e.startOffset),!0);var t=c(new s(e.startContainer,e.startOffset),!0),n=c(new s(e.endContainer,e.endOffset),!1),i=r.getDocument(e.startContainer).body.createTextRange();return i.setEndPoint("StartToStart",t),i.setEndPoint("EndToEnd",n),i}),n.prototype.getName=function(){return"WrappedRange"},e.WrappedRange=n,e.createRange=function(t){return t=u(t,"createRange"),new n(e.createNativeRange(t))},e.createRangyRange=function(e){return e=u(e,"createRangyRange"),new o(e)},e.createIframeRange=function(n){return t.deprecationNotice("createIframeRange()","createRange(iframeEl)"),e.createRange(n)},e.createIframeRangyRange=function(n){return t.deprecationNotice("createIframeRangyRange()","createRangyRange(iframeEl)"),e.createRangyRange(n)},e.addCreateMissingNativeApiListener(function(t){var n=t.document;typeof n.createRange=="undefined"&&(n.createRange=function(){return e.createRange(n)}),n=t=null})}),rangy.createModule("WrappedSelection",function(e,t){function h(e){return typeof e=="string"?e=="backward":!!e}function p(e,n){if(!e)return window;if(r.isWindow(e))return e;if(e instanceof q)return e.win;var i=r.getContentDocument(e);if(!i)throw t.createError(n+"(): "+"Parameter must be a Window object or DOM node");return r.getWindow(i)}function d(e){return p(e,"getWinSelection").getSelection()}function v(e){return p(e,"getDocSelection").document.selection}function A(e,t,n){var r=n?"end":"start",i=n?"start":"end";e.anchorNode=t[r+"Container"],e.anchorOffset=t[r+"Offset"],e.focusNode=t[i+"Container"],e.focusOffset=t[i+"Offset"]}function O(e){var t=e.nativeSelection;e.anchorNode=t.anchorNode,e.anchorOffset=t.anchorOffset,e.focusNode=t.focusNode,e.focusOffset=t.focusOffset}function M(e){e.anchorNode=e.focusNode=null,e.anchorOffset=e.focusOffset=0,e.rangeCount=0,e.isCollapsed=!0,e._ranges.length=0}function _(t){var n;return t instanceof s?(n=e.createNativeRange(t.getDocument()),n.setEnd(t.endContainer,t.endOffset),n.setStart(t.startContainer,t.startOffset)):t instanceof o?n=t.nativeRange:e.features.implementsDomRange&&t instanceof r.getWindow(t.startContainer).Range&&(n=t),n}function D(e){if(!e.length||e[0].nodeType!=1)return!1;for(var t=1,n=e.length;t<n;++t)if(!r.isAncestorOf(e[0],e[t]))return!1;return!0}function P(e){var n=e.getNodes();if(!D(n))throw t.createError("getSingleElementFromRange: range "+e.inspect()+" did not consist of a single element");return n[0]}function H(e){return!!e&&typeof e.text!="undefined"}function B(e,t){var n=new o(t);e._ranges=[n],A(e,n,!1),e.rangeCount=1,e.isCollapsed=n.collapsed}function j(t){t._ranges.length=0;if(t.docSelection.type=="None")M(t);else{var n=t.docSelection.createRange();if(H(n))B(t,n);else{t.rangeCount=n.length;var i,s=r.getDocument(n.item(0));for(var o=0;o<t.rangeCount;++o)i=e.createRange(s),i.selectNode(n.item(o)),t._ranges.push(i);t.isCollapsed=t.rangeCount==1&&t._ranges[0].collapsed,A(t,t._ranges[t.rangeCount-1],!1)}}}function F(e,n){var i=e.docSelection.createRange(),s=P(n),o=r.getDocument(i.item(0)),u=r.getBody(o).createControlRange();for(var a=0,f=i.length;a<f;++a)u.add(i.item(a));try{u.add(s)}catch(l){throw t.createError("addRange(): Element within the specified Range could not be added to control selection (does it have layout?)")}u.select(),j(e)}function q(e,t,n){this.nativeSelection=e,this.docSelection=t,this._ranges=[],this.win=n,this.refresh()}function R(e){e.win=e.anchorNode=e.focusNode=e._ranges=null,e.detached=!0}function z(e,t){var n=U.length,r,i;while(n--){r=U[n],i=r.selection;if(t=="deleteAll")R(i);else if(r.win==e)return t=="delete"?(U.splice(n,1),!0):i}return t=="deleteAll"&&(U.length=0),null}function X(e,n){var i=r.getDocument(n[0].startContainer),s=r.getBody(i).createControlRange();for(var o=0,u;o<rangeCount;++o){u=P(n[o]);try{s.add(u)}catch(a){throw t.createError("setRanges(): Element within the one of the specified Ranges could not be added to control selection (does it have layout?)")}}s.select(),j(e)}function Q(e,t){if(e.anchorNode&&r.getDocument(e.anchorNode)!==r.getDocument(t))throw new u("WRONG_DOCUMENT_ERR")}function G(e){var t=[],n=new a(e.anchorNode,e.anchorOffset),r=new a(e.focusNode,e.focusOffset),i=typeof e.getName=="function"?e.getName():"Selection";if(typeof e.rangeCount!="undefined")for(var o=0,u=e.rangeCount;o<u;++o)t[o]=s.inspect(e.getRangeAt(o));return"["+i+"(Ranges: "+t.join(", ")+")(anchor: "+n.inspect()+", focus: "+r.inspect()+"]"}e.requireModules(["DomUtil","DomRange","WrappedRange"]),e.config.checkSelectionRanges=!0;var n="boolean",r=e.dom,i=e.util,s=e.DomRange,o=e.WrappedRange,u=e.DOMException,a=r.DomPosition,f,l,c="Control",m=e.util.isHostMethod(window,"getSelection"),g=e.util.isHostObject(document,"selection");e.features.implementsWinGetSelection=m,e.features.implementsDocSelection=g;var y=g&&(!m||e.config.preferTextRange);y?(f=v,e.isSelectionValid=function(e){var t=p(e,"isSelectionValid").document,n=t.selection;return n.type!="None"||r.getDocument(n.createRange().parentElement())==t}):m?(f=d,e.isSelectionValid=function(){return!0}):t.fail("Neither document.selection or window.getSelection() detected."),e.getNativeSelection=f;var b=f(),w=e.createNativeRange(document),E=r.getBody(document),S=i.areHostProperties(b,["anchorNode","focusNode","anchorOffset","focusOffset"]);e.features.selectionHasAnchorAndFocus=S;var x=i.isHostMethod(b,"extend");e.features.selectionHasExtend=x;var T=typeof b.rangeCount=="number";e.features.selectionHasRangeCount=T;var N=!1,C=!0;i.areHostMethods(b,["addRange","getRangeAt","removeAllRanges"])&&typeof b.rangeCount=="number"&&e.features.implementsDomRange&&function(){var e=window.getSelection();if(e){var t=r.getBody(document),n=t.appendChild(document.createElement("div"));n.contentEditable="false";var i=n.appendChild(document.createTextNode("   ")),s=document.createRange();s.setStart(i,1),s.collapse(!0),e.addRange(s),C=e.rangeCount==1,e.removeAllRanges();var o=s.cloneRange();s.setStart(i,0),o.setEnd(i,3),o.setStart(i,2),e.addRange(s),e.addRange(o),N=e.rangeCount==2,t.removeChild(n),e.removeAllRanges(),s.detach(),o.detach()}}(),e.features.selectionSupportsMultipleRanges=N,e.features.collapsedNonEditableSelectionsSupported=C;var k=!1,L;E&&i.isHostMethod(E,"createControlRange")&&(L=E.createControlRange(),i.areHostProperties(L,["item","add"])&&(k=!0)),e.features.implementsControlRange=k,S?l=function(e){return e.anchorNode===e.focusNode&&e.anchorOffset===e.focusOffset}:l=function(e){return e.rangeCount?e.getRangeAt(e.rangeCount-1).collapsed:!1};var I;i.isHostMethod(b,"getRangeAt")?I=function(e,t){try{return e.getRangeAt(t)}catch(n){return null}}:S&&(I=function(t){var n=r.getDocument(t.anchorNode),i=e.createRange(n);return i.setStart(t.anchorNode,t.anchorOffset),i.setEnd(t.focusNode,t.focusOffset),i.collapsed!==this.isCollapsed&&(i.setStart(t.focusNode,t.focusOffset),i.setEnd(t.anchorNode,t.anchorOffset)),i});var U=[];e.getSelection=function(e){if(e&&e instanceof q)return e.refresh(),e;e=p(e,"getSelection");var t=z(e),n=f(e),r=g?v(e):null;return t?(t.nativeSelection=n,t.docSelection=r,t.refresh()):(t=new q(n,r,e),U.push({win:e,selection:t})),t},e.getIframeSelection=function(n){return t.deprecationNotice("getIframeSelection()","getSelection(iframeEl)"),e.getSelection(r.getIframeWindow(n))};var W=q.prototype;if(!y&&S&&i.areHostMethods(b,["removeAllRanges","addRange"])){W.removeAllRanges=function(){this.nativeSelection.removeAllRanges(),M(this)};var V=function(t,n){var r=s.getRangeDocument(n),i=e.createRange(r);i.collapseToPoint(n.endContainer,n.endOffset),t.nativeSelection.addRange(_(i)),t.nativeSelection.extend(n.startContainer,n.startOffset),t.refresh()};T?W.addRange=function(t,n){if(k&&g&&this.docSelection.type==c)F(this,t);else if(h(n)&&x)V(this,t);else{var r;N?r=this.rangeCount:(this.removeAllRanges(),r=0),this.nativeSelection.addRange(_(t).cloneRange()),this.rangeCount=this.nativeSelection.rangeCount;if(this.rangeCount==r+1){if(e.config.checkSelectionRanges){var i=I(this.nativeSelection,this.rangeCount-1);i&&!s.rangesEqual(i,t)&&(t=new o(i))}this._ranges[this.rangeCount-1]=t,A(this,t,K(this.nativeSelection)),this.isCollapsed=l(this)}else this.refresh()}}:W.addRange=function(e,t){h(t)&&x?V(this,e):(this.nativeSelection.addRange(_(e)),this.refresh())},W.setRanges=function(e){if(k&&e.length>1)X(this,e);else{this.removeAllRanges();for(var t=0,n=e.length;t<n;++t)this.addRange(e[t])}}}else{if(!(i.isHostMethod(b,"empty")&&i.isHostMethod(w,"select")&&k&&y))return t.fail("No means of selecting a Range or TextRange was found"),!1;W.removeAllRanges=function(){try{this.docSelection.empty();if(this.docSelection.type!="None"){var e;if(this.anchorNode)e=r.getDocument(this.anchorNode);else if(this.docSelection.type==c){var t=this.docSelection.createRange();t.length&&(e=r.getDocument(t.item(0)).body.createTextRange())}if(e){var n=e.body.createTextRange();n.select(),this.docSelection.empty()}}}catch(i){}M(this)},W.addRange=function(e){this.docSelection.type==c?F(this,e):(o.rangeToTextRange(e).select(),this._ranges[0]=e,this.rangeCount=1,this.isCollapsed=this._ranges[0].collapsed,A(this,e,!1))},W.setRanges=function(e){this.removeAllRanges();var t=e.length;t>1?X(this,e):t&&this.addRange(e[0])}}W.getRangeAt=function(e){if(e<0||e>=this.rangeCount)throw new u("INDEX_SIZE_ERR");return this._ranges[e].cloneRange()};var $;if(y)$=function(t){var n;e.isSelectionValid(t.win)?n=t.docSelection.createRange():(n=r.getBody(t.win.document).createTextRange(),n.collapse(!0)),t.docSelection.type==c?j(t):H(n)?B(t,n):M(t)};else if(i.isHostMethod(b,"getRangeAt")&&typeof b.rangeCount=="number")$=function(t){if(k&&g&&t.docSelection.type==c)j(t);else{t._ranges.length=t.rangeCount=t.nativeSelection.rangeCount;if(t.rangeCount){for(var n=0,r=t.rangeCount;n<r;++n)t._ranges[n]=new e.WrappedRange(t.nativeSelection.getRangeAt(n));A(t,t._ranges[t.rangeCount-1],K(t.nativeSelection)),t.isCollapsed=l(t)}else M(t)}};else{if(!S||typeof b.isCollapsed!=n||typeof w.collapsed!=n||!e.features.implementsDomRange)return t.fail("No means of obtaining a Range or TextRange from the user's selection was found"),!1;$=function(e){var t,n=e.nativeSelection;n.anchorNode?(t=I(n,0),e._ranges=[t],e.rangeCount=1,O(e),e.isCollapsed=l(e)):M(e)}}W.refresh=function(e){var t=e?this._ranges.slice(0):null,n=this.anchorNode,r=this.anchorOffset;$(this);if(e){var i=t.length;if(i!=this._ranges.length)return!0;if(this.anchorNode!=n||this.anchorOffset!=r)return!0;while(i--)if(!s.rangesEqual(t[i],this._ranges[i]))return!0;return!1}};var J=function(t,n){var r=t.getAllRanges();t.removeAllRanges();for(var i=0,s=r.length;i<s;++i)e.DomRange.rangesEqual(n,r[i])||t.addRange(r[i]);t.rangeCount||M(t)};k?W.removeRange=function(e){if(this.docSelection.type==c){var t=this.docSelection.createRange(),n=P(e),i=r.getDocument(t.item(0)),s=r.getBody(i).createControlRange(),o,u=!1;for(var a=0,f=t.length;a<f;++a)o=t.item(a),o!==n||u?s.add(t.item(a)):u=!0;s.select(),j(this)}else J(this,e)}:W.removeRange=function(e){J(this,e)};var K;!y&&S&&e.features.implementsDomRange?(K=function(e){var t=!1;return e.anchorNode&&(t=r.comparePoints(e.anchorNode,e.anchorOffset,e.focusNode,e.focusOffset)==1),t},W.isBackward=function(){return K(this)}):K=W.isBackward=function(){return!1},W.isBackwards=W.isBackward,W.toString=function(){var e=[];for(var t=0,n=this.rangeCount;t<n;++t)e[t]=""+this._ranges[t];return e.join("")},W.collapse=function(t,n){Q(this,t);var r=e.createRange(t);r.collapseToPoint(t,n),this.setSingleRange(r),this.isCollapsed=!0},W.collapseToStart=function(){if(!this.rangeCount)throw new u("INVALID_STATE_ERR");var e=this._ranges[0];this.collapse(e.startContainer,e.startOffset)},W.collapseToEnd=function(){if(!this.rangeCount)throw new u("INVALID_STATE_ERR");var e=this._ranges[this.rangeCount-1];this.collapse(e.endContainer,e.endOffset)},W.selectAllChildren=function(t){Q(this,t);var n=e.createRange(t);n.selectNodeContents(t),this.removeAllRanges(),this.addRange(n)},W.deleteFromDocument=function(){if(k&&g&&this.docSelection.type==c){var e=this.docSelection.createRange(),t;while(e.length)t=e.item(0),e.remove(t),t.parentNode.removeChild(t);this.refresh()}else if(this.rangeCount){var n=this.getAllRanges();if(n.length){this.removeAllRanges();for(var r=0,i=n.length;r<i;++r)n[r].deleteContents();this.addRange(n[i-1])}}},W.getAllRanges=function(){var e=[];for(var t=0,n=this._ranges.length;t<n;++t)e[t]=this.getRangeAt(t);return e},W.setSingleRange=function(e,t){this.removeAllRanges(),this.addRange(e,t)},W.containsNode=function(e,t){for(var n=0,r=this._ranges.length;n<r;++n)if(this._ranges[n].containsNode(e,t))return!0;return!1},W.toHtml=function(){var e=[];if(this.rangeCount)for(var t=0,n=this._ranges.length;t<n;++t)e.push(this._ranges[t].toHtml());return e.join("")},W.getName=function(){return"WrappedSelection"},W.inspect=function(){return G(this)},W.detach=function(){z(this.win,"delete"),R(this)},q.detachAll=function(){z(null,"deleteAll")},q.inspect=G,q.isDirectionBackward=h,e.Selection=q,e.selectionPrototype=W,e.addCreateMissingNativeApiListener(function(t){typeof t.getSelection=="undefined"&&(t.getSelection=function(){return e.getSelection(t)}),t=null})}),rangy.createModule("SaveRestore",function(e,t){function i(e,t){return(t||document).getElementById(e)}function s(e,t){var i="selectionBoundary_"+ +(new Date)+"_"+(""+Math.random()).slice(2),s,o=n.getDocument(e.startContainer),u=e.cloneRange();return u.collapse(t),s=o.createElement("span"),s.id=i,s.style.lineHeight="0",s.style.display="none",s.className="rangySelectionBoundary",s.appendChild(o.createTextNode(r)),u.insertNode(s),u.detach(),s}function o(e,n,r,s){var o=i(r,e);o?(n[s?"setStartBefore":"setEndBefore"](o),o.parentNode.removeChild(o)):t.warn("Marker element has been removed. Cannot restore selection.")}function u(e,t){return t.compareBoundaryPoints(e.START_TO_START,e)}function a(t,n){var r,i,o=e.DomRange.getRangeDocument(t),u=t.toString();return t.collapsed?(i=s(t,!1),{document:o,markerId:i.id,collapsed:!0}):(i=s(t,!1),r=s(t,!0),{document:o,startMarkerId:r.id,endMarkerId:i.id,collapsed:!1,backward:n,toString:function(){return"original text: '"+u+"', new text: '"+t.toString()+"'"}})}function f(n,r){var s=n.document;typeof r=="undefined"&&(r=!0);var u=e.createRange(s);if(n.collapsed){var a=i(n.markerId,s);if(a){a.style.display="inline";var f=a.previousSibling;f&&f.nodeType==3?(a.parentNode.removeChild(a),u.collapseToPoint(f,f.length)):(u.collapseBefore(a),a.parentNode.removeChild(a))}else t.warn("Marker element has been removed. Cannot restore selection.")}else o(s,u,n.startMarkerId,!0),o(s,u,n.endMarkerId,!1);return r&&u.normalizeBoundaries(),u}function l(t,n){var r=[],s,o;t=t.slice(0),t.sort(u);for(var f=0,l=t.length;f<l;++f)r[f]=a(t[f],n);for(f=l-1;f>=0;--f)s=t[f],o=e.DomRange.getRangeDocument(s),s.collapsed?s.collapseAfter(i(r[f].markerId,o)):(s.setEndBefore(i(r[f].endMarkerId,o)),s.setStartAfter(i(r[f].startMarkerId,o)));return r}function c(n){if(!e.isSelectionValid(n))return t.warn("Cannot save selection. This usually happens when the selection is collapsed and the selection document has lost focus."),null;var r=e.getSelection(n),i=r.getAllRanges(),s=i.length==1&&r.isBackward(),o=l(i,s);return r.setRanges(i),{win:n,rangeInfos:o,restored:!1}}function h(e){var t=[],n=e.length;for(var r=n-1;r>=0;r--)t[r]=f(e[r],!0);return t}function p(t,n){if(!t.restored){var r=t.rangeInfos,i=e.getSelection(t.win),s=h(r),o=r.length;o==1&&n&&e.features.selectionHasExtend&&r[0].backward?(i.removeAllRanges(),i.addRange(s[0],!0)):i.setRanges(s),t.restored=!0}}function d(e,t){var n=i(t,e);n&&n.parentNode.removeChild(n)}function v(e){var t=e.rangeInfos;for(var n=0,r=t.length,i;n<r;++n)i=t[n],i.collapsed?d(e.doc,i.markerId):(d(e.doc,i.startMarkerId),d(e.doc,i.endMarkerId))}e.requireModules(["DomUtil","DomRange","WrappedRange"]);var n=e.dom,r="﻿";e.util.extend(e,{saveRange:a,restoreRange:f,saveRanges:l,restoreRanges:h,saveSelection:c,restoreSelection:p,removeMarkerElement:d,removeMarkers:v})}),LinkedList.prototype={length:0,first:null,last:null},LinkedList.prototype.append=function(e){typeof this.first=="undefined"||this.first===null?this.first=e:(e.next=null,this.last.next=e),e.prev=this.last,this.last=e,this.length++},LinkedList.prototype.insertAfter=function(e,t){t.prev=e,e?(t.next=e.next,typeof e.next!="undefined"&&e.next!==null&&(e.next.prev=t),e.next=t,e===this.last&&(this.last=t)):(t.next=this.first,this.first.prev=t,this.first=t),this.length++},LinkedList.prototype.remove=function(e){this.length>1?(typeof e.prev!="undefined"&&e.prev!==null&&(e.prev.next=e.next),typeof e.next!="undefined"&&e.next!==null&&(e.next.prev=e.prev),e==this.first&&(this.first=e.next),e==this.last&&(this.last=e.prev)):(this.first=null,this.last=null),e.prev=null,e.next=null,this.length--},LinkedList.prototype.toArray=function(){var e=[],t=this.first;while(t)e.push(t),t=t.next;return e},LinkedList.Node=function(e){this.prev=null,this.next=null,this.data=e},function(){var e;e={DEFAULT_LEAF_FORMATS:{background:"white",color:"black",family:"san-serif",size:"normal"},FONT_BACKGROUNDS:["black","blue","green","orange","purple","red","white","yellow"],FONT_COLORS:["black","blue","green","orange","red","white","yellow"],FONT_FAMILIES:["monospace","serif"],FONT_SIZES:["huge","large","small"],INDENT_FORMATS:{bullet:[0,1,2,3,4,5,6,7,8],indent:[0,1,2,3,4,5,6,7,8],list:[0,1,2,3,4,5,6,7,8]},LINE_RULES:{A:{},B:{},BR:{},BIG:{rename:"span"},CENTER:{rename:"span"},DEL:{rename:"s"},EM:{rename:"i"},H1:{rename:"div"},H2:{rename:"div"},H3:{rename:"div"},H4:{rename:"div"},H5:{rename:"div"},H6:{rename:"div"},I:{},INS:{rename:"span"},LI:{},OL:{},S:{},SMALL:{rename:"span"},SPAN:{},STRIKE:{rename:"s"},STRONG:{rename:"b"},U:{},UL:{}},LIST_TAGS:["OL","UL"],MAX_INDENT:9,MIN_INDENT:1,NOBREAK_SPACE:"﻿",SPECIAL_CLASSES:{ATOMIC:"atom",EXTERNAL:"ext"}},e.SPAN_FORMATS={background:e.FONT_BACKGROUNDS,color:e.FONT_COLORS,family:e.FONT_FAMILIES,size:e.FONT_SIZES},e.TAG_FORMATS={bold:[!0,!1],italic:[!0,!1],link:[!0,!1],strike:[!0,!1],underline:[!0,!1]},e.LEAF_FORMATS=_.extend({},e.SPAN_FORMATS,e.TAG_FORMATS),window.Scribe||(window.Scribe={}),window.Scribe.Constants=e}.call(this),function(){var e;e=function(){function e(e){this.editor=e,this.cursors={},this.editor.renderer.addStyle({"#cursor-container":{"font-family":"'Helvetica', 'Arial', san-serif","font-size":"13px","line-height":"15px"},".cursor":{display:"inline-block",height:"12px",position:"absolute",width:"0px"},".cursor-name":{"border-bottom-right-radius":"3px","border-top-left-radius":"3px","border-top-right-radius":"3px",color:"white",display:"inline-block",left:"-1px",padding:"2px 8px",position:"absolute",top:"-18px"},".cursor-inner":{display:"inline-block",width:"2px",position:"absolute",height:"15px",left:"-1px"},".editor > .line:first-child .cursor-name":{"border-top-left-radius":"0px","border-bottom-left-radius":"3px",top:"15px"}})}return e.prototype.applyDeltaToCursors=function(e){var t=this;return this.jetSyncApplyDelta(e,function(e,n){return t.shiftCursors(e,n.length)},function(e,n){return t.shiftCursors(e,e-n)})},e.prototype.shiftCursors=function(e,t){var n,r,i,s;i=this.cursors,s=[];for(r in i){n=i[r];if(n===void 0||n.index<e)continue;n.index>e?t>0?s.push(this.setCursor(n.userId,n.index+t,n.name,n.color)):s.push(this.setCursor(n.userId,n.index+Math.max(t,e-n.index),n.name,n.color)):s.push(void 0)}return s},e.prototype.setCursor=function(e,t,n,r){var i,s,o,u,a,f,l,c,h;i=this.doc.root.ownerDocument.getElementById(Scribe.Editor.CURSOR_PREFIX+e),i==null&&(i=this.doc.root.ownerDocument.createElement("span"),i.classList.add("cursor"),i.classList.add(Scribe.Constants.SPECIAL_CLASSES.EXTERNAL),i.id=Scribe.Editor.CURSOR_PREFIX+e,o=this.doc.root.ownerDocument.createElement("span"),o.classList.add("cursor-inner"),o.classList.add(Scribe.Constants.SPECIAL_CLASSES.EXTERNAL),a=this.doc.root.ownerDocument.createElement("span"),a.classList.add("cursor-name"),a.classList.add(Scribe.Constants.SPECIAL_CLASSES.EXTERNAL),a.textContent=n,o.style["background-color"]=a.style["background-color"]=r,i.appendChild(a),i.appendChild(o),this.cursorContainer.appendChild(i)),this.cursors[e]={index:t,name:n,color:r,userId:e},f=new Scribe.Position(this,t),h=Scribe.DOM.splitNode(f.leafNode,f.offset),u=h[0],l=h[1],s=h[2];if(l==null||l.offsetTop===0&&l.offsetLeft===0)return u!=null?(c=u.ownerDocument.createElement("span"),u.parentNode.appendChild(c),i.style.top=c.offsetTop,i.style.left=c.offsetLeft,c.parentNode.removeChild(c)):l!=null?(i.style.top=l.parentNode.offsetTop,i.style.left=l.parentNode.offsetLeft):console.warn("Could not set cursor");i.style.top=l.parentNode,i.style.top=l.offsetTop,i.style.left=l.offsetLeft;if(s)return Scribe.DOM.mergeNodes(u,l)},e.prototype.moveCursor=function(e,t){if(this.cursors[e])return this.setCursor(e,t,this.cursors[e].name,this.cursors[e].color)},e.prototype.clearCursors=function(){return _.each(this.doc.root.querySelectorAll(".cursor"),function(e){return e.parentNode.removeChild(e)})},e.prototype.removeCursor=function(e){var t;t=this.doc.root.ownerDocument.getElementById(Scribe.Editor.CURSOR_PREFIX+e);if(t!=null)return t.parentNode.removeChild(t)},e}(),window.Scribe||(window.Scribe={}),window.Scribe.MultiCursorManager=e}.call(this),function(){var e;e={getEditor:function(e){return e||(e=Scribe.Editor.editors[0]),_.isNumber(e)?Scribe.Editor.editors[e]:e},getHtml:function(e){var t;return t=this.getDocument(e),t.root},getDocument:function(e){return e=this.getEditor(e),e.doc},checkDocumentConsistency:function(e,t){var n,r,i;return t==null&&(t=!1),i=_.map(_.clone(e.root.childNodes),function(e){var t;return t=e.querySelectorAll("*"),_.filter(t,function(e){return e.nodeType===e.ELEMENT_NODE&&!e.classList.contains(Scribe.Constants.SPECIAL_CLASSES.EXTERNAL)&&(e.nodeName==="BR"||e.firstChild==null||e.firstChild.nodeType===e.TEXT_NODE)})}),r=e.lines.toArray(),n=function(){var t,n,s=this;return r.length!==_.values(e.lineMap).length?(console.error("doc.lines and doc.lineMap differ in length",r.length,_.values(e.lineMap).length),!1):_.any(r,function(t){return t==null||e.lineMap[t.id]!==t?(t!=null?console.error(t,"does not match",e.lineMap[t.id]):console.error("null line"),!0):!1})?!1:(t=n=null,_.any(r,function(e){return _.any(e.leaves.toArray(),function(r){return r.node.parentNode===null?(t=r,n=e,!0):!1})})?(console.error("Missing from DOM",n,t),!1):_.any(r,function(e){var t;return t=_.reduce(e.leaves.toArray(),function(e,t){return t.length+e},0),e.trailingNewline&&(t+=1),t!==e.length?(console.error("incorrect line length",t,e.length),!0):!1})?!1:_.any(r,function(e){return e.node.tagName!=="OL"&&e.node.tagName!=="UL"||e.node.firstChild.tagName==="LI"?!1:(console.error("inconsistent bullet/list",e),!0)})?!1:r.length!==i.length?(console.error("doc.lines and nodesByLine differ in length",r,i),!1):_.any(r,function(e,t){var n,r,s,o;return n=_.reduce(e.node.childNodes,function(e,t){return Scribe.Utils.getNodeLength(t)+e},0),e.trailingNewline&&(n+=1),e.length!==n?(console.error(e,e.length,n,"differ in length"),!0):(s=e.leaves.toArray(),r=_.map(s,function(e){return e.node}),_.isEqual(r,i[t])?(s=_.map(s,function(e){return _.pick(e,"formats","length","line","node","text")}),e.rebuild(),o=_.map(e.leaves.toArray(),function(e){return _.pick(e,"formats","length","line","node","text")}),_.isEqual(s,o)?!1:(console.error(s,"leaves differ from",o),!0)):(console.error(e,r,"nodes differ from",i[t]),!0))})?!1:!0)},n()?!0:(t&&(console.error(e.root),console.error(i),console.error(r),console.error(e.lineMap)),!1)},Test:{getRandomLength:function(){var e;return e=Math.random(),e<.1?1:e<.6?_.random(0,2):e<.8?_.random(3,4):e<.9?_.random(5,9):_.random(10,50)},getRandomOperation:function(e,t,n){var r,i,s,o,u,a,f;return i=_.keys(n),a=Math.random(),u=e.getLength()-1,a<.2?s=0:a<.4?s=u:s=_.random(0,u),o=Scribe.Debug.Test.getRandomLength()+1,a=Math.random(),a<.5?{op:"insertAt",args:[s,Scribe.Debug.Test.getRandomString(t,o)]}:a<.75?s+o>u?null:{op:"deleteAt",args:[s,o-1]}:(r=i[_.random(0,i.length-1)],f=n[r][_.random(0,n[r].length-1)],r==="link"&&f===!0&&(f="http://www.google.com"),{op:"formatAt",args:[s,o,r,f]})},getRandomString:function(e,t){var n,r,i;return _.map(function(){i=[];for(var e=0,n=t-1;0<=n?e<=n:e>=n;0<=n?e++:e--)i.push(e);return i}.apply(this),function(){return e[_.random(0,e.length-1)]}).join("")}}},window.Scribe||(window.Scribe={}),window.Scribe.Debug=e}.call(this),function(){var e;e=function(){function e(e){this.root=e,this.buildLines()}return e.INDENT_PREFIX="indent-",e.prototype.appendLine=function(e){return this.insertLineBefore(e,null)},e.prototype.buildLines=function(){return this.reset(),Scribe.Normalizer.normalizeDoc(this.root),this.rebuild()},e.prototype.cleanNode=function(e){var t;if(e.classList.contains(Scribe.Constants.SPECIAL_CLASSES.EXTERNAL))return;return t=this.findLine(e),t!=null&&this.updateLine(t)?(e.classList.remove(Scribe.Line.DIRTY_CLASS),!0):!1},e.prototype.findLeaf=function(e){var t,n;n=e.parentNode;while(n!=null&&!Scribe.Line.isLineNode(n))n=n.parentNode;return n==null?null:(t=this.findLine(n),t.findLeaf(e))},e.prototype.findLine=function(e){return e=this.findLineNode(e),e!=null?this.lineMap[e.id]:null},e.prototype.findLineAtOffset=function(e){var t,n=this;return t=this.lines.first,_.all(this.lines.toArray(),function(r,i){return t=r,e<r.length?!1:(i<n.lines.length-1&&(e-=r.length),!0)}),[t,e]},e.prototype.findLineNode=function(e){while(e!=null&&!Scribe.Line.isLineNode(e))e=e.parentNode;return e},e.prototype.insertLineBefore=function(e,t){var n;return n=new Scribe.Line(this,e),t!==null?this.lines.insertAfter(t.prev,n):this.lines.append(n),this.lineMap[n.id]=n,n},e.prototype.mergeLines=function(e,t){if(e==null||t==null)return;return _.each(_.clone(t.node.childNodes),function(t){return e.node.appendChild(t)}),Scribe.Utils.removeNode(t.node),this.removeLine(t),e.trailingNewline=t.trailingNewline,e.rebuild()},e.prototype.rebuild=function(){var e=this;return this.reset(),_.each(this.root.childNodes,function(t){return e.appendLine(t)})},e.prototype.rebuildDirty=function(){var e,t=this;return this.root.firstChild!=null&&this.root.firstChild.classList.add(Scribe.Line.DIRTY_CLASS),this.root.lastChild!=null&&this.root.lastChild.classList.add(Scribe.Line.DIRTY_CLASS),e=_.clone(this.root.getElementsByClassName(Scribe.Line.DIRTY_CLASS)),_.each(e,function(n,r){var i,s,o;t.cleanNode(n),s=n.previousSibling,i=n.nextSibling;while(s!=null&&s!==e[r-1])t.cleanNode(s),s=s.previousSibling;o=[];while(i!=null&&i!==e[r+1])t.cleanNode(i),o.push(i=i.nextSibling);return o})},e.prototype.removeLine=function(e){return delete this.lineMap[e.id],this.lines.remove(e)},e.prototype.reset=function(){return this.lines=new LinkedList,this.lineMap={}},e.prototype.splitLine=function(e,t){var n,r,i;return i=Scribe.DOM.splitNode(e.node,t,!0),n=i[0],r=i[1],e.node=n,this.updateLine(e),this.insertLineBefore(r,e.next)},e.prototype.toDelta=function(){var e,t,n;return t=this.lines.toArray(),n=_.flatten(_.map(t,function(e,t){return n=Tandem.Delta.copy(e.delta).ops,n}),!0),e=new Tandem.Delta(0,n),e},e.prototype.updateLine=function(e){return e.rebuild()},e}(),window.Scribe||(window.Scribe={}),window.Scribe.Document=e}.call(this),function(){var e,t=[].slice;e={getChildNodes:function(e){return _.filter(e.childNodes,function(e){return e.nodeType===e.TEXT_NODE||!e.classList.contains(Scribe.Constants.SPECIAL_CLASSES.EXTERNAL)})},toNodeArray:function(e){return _.map(e,function(e){return e})},mergeNodes:function(e,t){return e==null?t:t==null?e:(this.moveChildren(e,t),t.parentNode.removeChild(t),(e.tagName==="OL"||e.tagName==="UL")&&e.childNodes.length===2&&Scribe.DOM.mergeNodes(e.firstChild,e.lastChild),e)},moveChildren:function(e,t){return _.each(_.clone(t.childNodes),function(t){return e.appendChild(t)})},splitAfter:function(e,t){var n,r;if(e===t||e.parentNode===t)return!1;r=e.parentNode,n=r.cloneNode(!1),r.parentNode.insertBefore(n,r.nextSibling);while(e.nextSibling!=null)n.appendChild(e.nextSibling);return Scribe.DOM.splitAfter(r,t)},splitNode:function(e,t,n){var r,i,s,o,u,a,f,l,c,h;n==null&&(n=!1);if(t>Scribe.Utils.getNodeLength(e))throw new Error("Splitting at offset greater than node length");e.nodeType===e.TEXT_NODE&&(e=this.wrap(e.ownerDocument.createElement("span"),e));if(!n){if(t===0)return[e.previousSibling,e,!1];if(t===Scribe.Utils.getNodeLength(e))return[e,e.nextSibling,!1]}a=e,l=e.cloneNode(!1),e.parentNode.insertBefore(l,a.nextSibling);if(Scribe.Utils.isTextNodeParent(e))return i=e.textContent.substring(0,t),r=e.textContent.substring(t),a.textContent=i,l.textContent=r,[a,l,!0];c=Scribe.Utils.getChildAtOffset(e,t),s=c[0],t=c[1],h=Scribe.DOM.splitNode(s,t),o=h[0],u=h[1];while(u!==null)f=u.nextSibling,l.appendChild(u),u=f;return[a,l,!0]},switchTag:function(e,t){var n;if(e.tagName===t)return;return n=e.ownerDocument.createElement(t),this.moveChildren(n,e),e.parentNode.replaceChild(n,e),e.className&&(n.className=e.className),e.id&&(n.id=e.id),n},traversePostorder:function(e,t,n){var r,i;n==null&&(n=t);if(e==null)return;r=e.firstChild,i=[];while(r!=null)Scribe.DOM.traversePostorder.call(n,r,t),r=t.call(n,r),r!=null?i.push(r=r.nextSibling):i.push(void 0);return i},traversePreorder:function(){var e,n,r,i,s,o,u,a,f;a=arguments[0],u=arguments[1],s=arguments[2],n=arguments[3],e=5<=arguments.length?t.call(arguments,4):[],n==null&&(n=s);if(a==null)return;r=a.firstChild,f=[];while(r!=null)o=u+Scribe.Utils.getNodeLength(r),i=r.innerHTML,r=s.apply(n,[r,u].concat(e)),Scribe.DOM.traversePreorder.apply(Scribe.DOM.traversePreorder,[r,u,s,n].concat(e)),r!=null&&r.innerHTML===i?(r=r.nextSibling,f.push(u=o)):f.push(void 0);return f},traverseSiblings:function(e,t,n){var r,i;i=[];while(e!=null){r=e.nextSibling,n(e);if(e===t)break;i.push(e=r)}return i},unwrap:function(e){var t;return t=e.firstChild,_.each(_.clone(e.childNodes),function(t){return e.parentNode.insertBefore(t,e)}),e.parentNode.removeChild(e),t},wrap:function(e,t){return t.parentNode.insertBefore(e,t),e.appendChild(t),e}},window.Scribe||(window.Scribe={}),window.Scribe.DOM=e}.call(this),function(){var e,t,n,r,i,s,o,u,a,f,l,c={}.hasOwnProperty,h=function(e,t){function r(){this.constructor=e}for(var n in t)c.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e},p=[].slice;n=function(e){var t=this;return r.call(this,function(){return t.selection.preserve(function(){return f.call(t,function(){return a.call(t,function(){return e.call(t)})})})})},r=function(e){var t;return t=this.ignoreDomChanges,this.ignoreDomChanges=!0,e(),this.ignoreDomChanges=t},o=function(){var e,t,n,r=this;return t=function(){},e=function(){t=_.once(e);if(r.ignoreDomChanges)return;return l.call(r)},n=function(){var e;if(r.ignoreDomChanges)return;return e=t,_.defer(function(){return e.call(null)})},t=_.once(e),this.root.addEventListener("DOMSubtreeModified",n)},t=function(e,t){var n,r,i,s,o,u;if(t<=0)return;u=this.doc.findLineAtOffset(e),i=u[0],o=u[1],n=i;while(n!=null&&t>0)r=Math.min(t,n.length-o),s=n.next,n.length===r?(Scribe.Utils.removeNode(n.node),this.doc.removeLine(n)):n.deleteText(o,r),t-=r,n=s,o=0;if(i!=null&&!i.trailingNewline)return this.doc.mergeLines(i,i.next)},i=function(){var e;if((e=this.doc.lines.last)!=null?!e.trailingNewline:!void 0)return this.insertAt(this.getLength(),"\n")},s=function(e,t,n,r){var i,s,o,u;o=this.doc.findLineAtOffset(e),i=o[0],s=o[1],u=[];while(i!=null&&t>0)Scribe.Line.FORMATS[n]!=null?t>i.length-s&&i.format(n,r):Scribe.Constants.LEAF_FORMATS[n]!=null?i.length-s>=t?i.formatText(s,t,n,r):i.formatText(s,i.length-s,n,r):console.warn("Unsupported format",n,r),t-=i.length-s,s=0,u.push(i=i.next);return u},u=function(e,t,n){var r,i,s,o,u,a=this;return n==null&&(n={}),t=t.replace(/\r\n/g,"\n"),t=t.replace(/\r/g,"\n"),s=t.split("\n"),e===this.getLength()?(s[s.length-1]===""&&s.pop(),i=this.doc.splitLine(this.doc.lines.last,this.doc.lines.last.length),o=0):(u=this.doc.findLineAtOffset(e),i=u[0],o=u[1]),_.each(s,function(e,t){return i.insertText(o,e,n),t<s.length-1&&(i=a.doc.splitLine(i,o+e.length)),o=0})},a=function(e){return e.call(this),this.doc.rebuildDirty()},f=function(e){var t,n,r,i;return i=this.doc.toDelta(),e(),r=this.doc.toDelta(),n=r.decompose(i),t=i.compose(n),console.assert(t.isEqual(r),i,r,n,t),n.isIdentity()||this.emit(Scribe.Editor.events.TEXT_CHANGE,n),n},l=function(){var e=this;return r.call(this,function(){return e.selection.preserve(function(){return f.call(e,function(){var t,n,r,i;Scribe.Normalizer.breakBlocks(e.root),n=e.doc.lines.toArray(),t=e.root.firstChild,_.each(n,function(n,r){var i;while(n.node!==t){if(n.node.parentNode!==e.root){e.doc.removeLine(n);return}i=e.doc.insertLineBefore(t,n),t=t.nextSibling}return e.doc.updateLine(n),t=t.nextSibling}),i=[];while(t!==null)r=e.doc.appendLine(t),i.push(t=t.nextSibling);return i})})})},e=function(e){function a(e,t){this.iframeContainer=e,this.options=_.extend(Scribe.Editor.DEFAULTS,t),this.id=_.uniqueId(Scribe.Editor.ID_PREFIX),_.isString(this.iframeContainer)&&(this.iframeContainer=document.getElementById(this.iframeContainer)),this.reset(!0),this.options.enabled&&this.enable()}return h(a,e),a.editors=[],a.CONTAINER_ID="scribe-container",a.ID_PREFIX="editor-",a.CURSOR_PREFIX="cursor-",a.DEFAULTS={cursor:0,enabled:!0,styles:{}},a.events={TEXT_CHANGE:"text-change",SELECTION_CHANGE:"selection-change"},a.prototype.disable=function(){var e=this;return r.call(this,function(){return e.root.setAttribute("contenteditable",!1)})},a.prototype.enable=function(){var e=this;if(!this.root.getAttribute("contenteditable"))return r.call(this,function(){return e.root.setAttribute("contenteditable",!0)})},a.prototype.reset=function(e){var t;return e==null&&(e=!1),this.ignoreDomChanges=!0,t=_.clone(this.options),t.keepHTML=e,this.renderer=new Scribe.Renderer(this.iframeContainer,t),this.contentWindow=this.renderer.iframe.contentWindow,this.root=this.contentWindow.document.getElementById(Scribe.Editor.CONTAINER_ID),this.doc=new Scribe.Document(this.root),this.selection=new Scribe.Selection(this),this.keyboard=new Scribe.Keyboard(this),this.undoManager=new Scribe.UndoManager(this),this.pasteManager=new Scribe.PasteManager(this),o.call(this),this.ignoreDomChanges=!1,Scribe.Editor.editors.push(this)},a.prototype.applyDelta=function(e,n){var o=this;n==null&&(n=!0);if(e.startLength===0&&this.getLength()===1)return this.setDelta(e);if(e.isIdentity())return;return r.call(this,function(){return o.selection.preserve(function(){var r;return console.assert(e.startLength===o.getLength(),"Trying to apply delta to incorrect doc length",e,o.doc,o.root),r=o.doc.toDelta(),e.apply(u,t,s,o),n||o.emit(Scribe.Editor.events.TEXT_CHANGE,e),console.assert(e.endLength===o.getLength(),"Applying delta resulted in incorrect end length",e,o.getLength()),i.call(o)})})},a.prototype.deleteAt=function(){var e,r=this;return e=1<=arguments.length?p.call(arguments,0):[],n.call(this,function(){return t.apply(r,e),i.call(r)})},a.prototype.formatAt=function(){var e,t=this;return e=1<=arguments.length?p.call(arguments,0):[],n.call(this,function(){return s.apply(t,e)})},a.prototype.getDelta=function(){return this.doc.toDelta()},a.prototype.getLength=function(){return this.doc.toDelta().endLength},a.prototype.getSelection=function(){return this.selection.getRange()},a.prototype.insertAt=function(){var e,t=this;return e=1<=arguments.length?p.call(arguments,0):[],n.call(this,function(){return u.apply(t,e),i.call(t)})},a.prototype.setDelta=function(e){var t;return t=e.startLength,e.startLength=this.getLength(),this.applyDelta(e),e.startLength=t},a.prototype.setSelection=function(e){return this.selection.setRange(e)},a}(EventEmitter2),window.Scribe||(window.Scribe={}),window.Scribe.Editor=e}.call(this),function(){var e;e=function(){function e(e){this.editor=e,this.hotkeys={},this.initListeners(),this.initHotkeys()}return e.KEYS={BACKSPACE:8,TAB:9,ENTER:13,LEFT:37,UP:38,RIGHT:39,DOWN:40,DELETE:46},e.HOTKEYS={BOLD:{key:"B",meta:!0},ITALIC:{key:"I",meta:!0},UNDERLINE:{key:"U",meta:!0},UNDO:{key:"Z",meta:!0,shift:!1},REDO:{key:"Z",meta:!0,shift:!0}},e.PRINTABLE,e.prototype.initListeners=function(){var e=this;return this.editor.root.addEventListener("keydown",function(t){var n;return t||(t=window.event),e.hotkeys[t.which]!=null&&(n=!1,_.each(e.hotkeys[t.which],function(r){var i;if(r.meta!=null&&t.metaKey!==r.meta)return;if(r.shift!=null&&t.shiftKey!==r.shift)return;e.editor.selection.update(!0),i=e.editor.getSelection();if(i==null)return;return n=!0,r.callback.call(null,i)})),n&&t.preventDefault(),!n})},e.prototype.initHotkeys=function(){var e=this;return this.addHotkey(Scribe.Keyboard.KEYS.TAB,function(){return e.editor.selection.deleteRange(),e.insertText("	")}),this.addHotkey(Scribe.Keyboard.KEYS.ENTER,function(){return e.editor.selection.deleteRange(),e.insertText("\n")}),this.addHotkey(Scribe.Keyboard.HOTKEYS.BOLD,function(t){return e.toggleFormat(t,"bold")}),this.addHotkey(Scribe.Keyboard.HOTKEYS.ITALIC,function(t){return e.toggleFormat(t,"italic")}),this.addHotkey(Scribe.Keyboard.HOTKEYS.UNDERLINE,function(t){return e.toggleFormat(t,"underline")})},e.prototype.addHotkey=function(e,t){return e=_.isObject(e)?_.clone(e):{key:e},_.isString(e.key)&&(e.key=e.key.toUpperCase().charCodeAt(0)),e.callback=t,this.hotkeys[e.key]==null&&(this.hotkeys[e.key]=[]),this.hotkeys[e.key].push(e)},e.prototype.indent=function(e,t){var n,r,i=this;return r=e.getLines(),n=function(e,n){var r,s;return t?(r=_.isNumber(e.formats[n])?e.formats[n]:e.formats[n]?1:0,r+=t,r=Math.min(Math.max(r,Scribe.Constants.MIN_INDENT),Scribe.Constants.MAX_INDENT)):r=!1,s=Scribe.Position.getIndex(e.node,0),i.editor.formatAt(s,0,n,r)},_.each(r,function(e){return e.formats.bullet!=null?n(e,"bullet"):e.formats.list!=null?n(e,"list"):n(e,"indent"),i.editor.doc.rebuildDirty()})},e.prototype.onIndentLine=function(e){var t;return e==null?!1:(t=e.getFormats(),t.bullet!=null||t.indent!=null||t.list!=null)},e.prototype.insertText=function(e){var t,n;return n=this.editor.getSelection(),this.editor.insertAt(n.start.index,e),t=new Scribe.Range(this.editor,n.start.index+e.length,n.start.index+e.length),this.editor.setSelection(t)},e.prototype.toggleFormat=function(e,t){var n;return n=e.getFormats(),this.editor.selection.format(t,!n[t])},e}(),window.Scribe||(window.Scribe={}),window.Scribe.Keyboard=e}.call(this),function(){var e,t,n={}.hasOwnProperty,r=function(e,t){function i(){this.constructor=e}for(var r in t)n.call(t,r)&&(e[r]=t[r]);return i.prototype=t.prototype,e.prototype=new i,e.__super__=t.prototype,e};e=function(e){function t(e,t,n){this.line=e,this.node=t,this.formats=_.clone(n),this.id=_.uniqueId(Scribe.Leaf.ID_PREFIX),this.node.tagName==="BR"&&(this.node.textContent=""),this.text=this.node.textContent,this.length=this.text.length}return r(t,e),t.ID_PREFIX="leaf-",t.isLeafNode=function(e){return e==null||e.nodeType!==e.ELEMENT_NODE||e.classList==null?!1:e.classList.contains(Scribe.Constants.SPECIAL_CLASSES.EXTERNAL)?!1:e.tagName==="BR"?!0:e.childNodes.length===1&&e.firstChild.nodeType===e.TEXT_NODE?!0:!1},t.isLeafParent=function(e){return e==null||e.nodeType!==e.ELEMENT_NODE||e.classList==null?!1:Scribe.Leaf.isLeafNode(e)?!1:e.classList.contains(Scribe.Constants.SPECIAL_CLASSES.EXTERNAL)?!1:e.childNodes.length===0?!1:e.childNodes.length>1||e.firstChild.nodeType!==e.TEXT_NODE},t.prototype.getFormats=function(e){var t;return e==null&&(e=!1),t=e?{}:_.clone(Scribe.Constants.DEFAULT_LEAF_FORMATS),_.extend(t,this.formats,this.line.formats)},t.prototype.getLineOffset=function(){return Scribe.Position.getIndex(this.node,0,this.line.node)},t.prototype.insertText=function(e,t){var n,r;return this.text=this.text.substring(0,e)+t+this.text.substring(e),r=Scribe.Position.findDeepestNode(this.line.doc.editor,this.node,e),n=r[0],e=r[1],n.textContent=n.textContent.substring(0,e)+t+n.textContent.substring(e),this.length=this.text.length},t}(LinkedList.Node),t=function(){function e(e,t){this.start=e,this.end=t,this.cur=this.start}return e.prototype.next=function(){var e,t;t=this.cur;if(this.cur===this.end||this.cur===null)this.cur=null;else if(this.cur.next!=null)this.cur=this.cur.next;else{e=this.cur.line.next;while(e!=null&&e.leaves.length===0)e=e.next;this.cur=e!=null?e.leaves.first:null}return t},e.prototype.toArray=function(){var e,t,n;e=[],t=new Scribe.LeafIterator(this.start,this.end);while(n=t.next())e.push(n);return e},e}(),window.Scribe||(window.Scribe={}),window.Scribe.Leaf=e,window.Scribe.LeafIterator=t}.call(this),function(){var e,t={}.hasOwnProperty,n=function(e,n){function i(){this.constructor=e}for(var r in n)t.call(n,r)&&(e[r]=n[r]);return i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype,e};e=function(e){function t(e,n){this.doc=e,this.node=n,this.id=_.uniqueId(Scribe.Line.ID_PREFIX),this.node.id=this.id,this.node.classList.add(Scribe.Line.CLASS_NAME),this.trailingNewline=!0,this.rebuild(),t.__super__.constructor.call(this,this.node)}return n(t,e),t.CLASS_NAME="line",t.DIRTY_CLASS="dirty",t.ID_PREFIX="line-",t.BLOCK_TAGS=["ADDRESS","BLOCKQUOTE","DD","DIV","DL","H1","H2","H3","H4","H5","H6","LI","OL","P","PRE","TABLE","TBODY","TD","TFOOT","TH","THEAD","TR","UL"],t.BREAK_TAGS=["BR","HR"],t.FORMATS={align:["center","justify","left","right"]},t.isLineNode=function(e){return e!=null&&e.classList!=null&&e.classList.contains(Scribe.Line.CLASS_NAME)},t.prototype.buildLeaves=function(e,t){var n=this;return _.each(_.clone(e.childNodes),function(e){var r,i,s,o;s=_.clone(t),o=Scribe.Utils.getFormatForContainer(e),r=o[0],i=o[1],r!=null&&(s[r]=i),Scribe.Leaf.isLeafNode(e)&&n.leaves.append(new Scribe.Leaf(n,e,s));if(Scribe.Leaf.isLeafParent(e))return n.buildLeaves(e,s)})},t.prototype.applyToContents=function(e,t,n){var r,i,s,o,u,a;if(t<=0)return;return u=this.splitContents(e),s=u[0],o=u[1],a=this.splitContents(e+t),r=a[0],i=a[1],Scribe.DOM.traverseSiblings(o,r,n)},t.prototype.deleteText=function(e,t){return this.applyToContents(e,t,function(e){return Scribe.Utils.removeNode(e)}),this.length===e+t&&(this.trailingNewline=!1),this.rebuild()},t.prototype.findLeaf=function(e){var t;t=this.leaves.first;while(t!=null){if(t.node===e)return t;t=t.next}return null},t.prototype.findLeafAtOffset=function(e){var t;return t=this.leaves.first,_.all(this.leaves.toArray(),function(n){return t=n,e>n.length&&n.next!=null?(e-=n.length,!0):!1}),[t,e]},t.prototype.format=function(e,t){return console.warn("Unimplemented")},t.prototype.formatText=function(e,t,n,r){var i,s,o,u,a,f,l,c,h,p=this;if(t<=0)return;return c=this.splitContents(e),a=c[0],l=c[1],h=this.splitContents(e+t),i=h[0],o=h[1],u=(l!=null?l.parentNode:void 0)||(a!=null?a.parentNode:void 0),r&&Scribe.Utils.getFormatDefault(n)!==r?(f=null,s=Scribe.Utils.createContainerForFormat(this.doc.root.ownerDocument,n,r),this.applyToContents(e,t,function(e){return f=e.nextSibling,e=Scribe.Utils.removeFormatFromSubtree(e,n),s.appendChild(e)}),this.node.insertBefore(s,f)):this.applyToContents(e,t,function(e){return Scribe.Utils.removeFormatFromSubtree(e,n)}),this.rebuild()},t.prototype.insertText=function(e,t,n){var r,i,s,o,u,a,f,l,c=this;return n==null&&(n={}),f=this.findLeafAtOffset(e),r=f[0],i=f[1],_.isEqual(r.formatting,n)?(r.insertText(i,t),this.length+=t.length,this.outerHTML=this.node.outerHTML,this.delta=this.toDelta()):(l=this.splitContents(e),u=l[0],s=l[1],a=this.node.ownerDocument.createElement("span"),a.textContent=t,o=(u!=null?u.parentNode:void 0)||(s!=null?s.parentNode:void 0),o.insertBefore(a,s),_.each(n,function(n,r){return c.formatText(e,t.length,r,n)}),this.rebuild())},t.prototype.rebuild=function(){if(this.node.parentNode===this.doc.root){if(this.outerHTML!=null&&this.outerHTML===this.node.outerHTML&&!this.node.classList.contains(Scribe.Line.DIRTY_CLASS))return!1;while(this.leaves!=null&&this.leaves.length>0)this.leaves.remove(this.leaves.first);this.leaves=new LinkedList,Scribe.Normalizer.normalizeLine(this.node),Scribe.Normalizer.optimizeLine(this.node),this.buildLeaves(this.node,{}),this.resetContent()}else this.doc.removeLine(this);return!0},t.prototype.resetContent=function(){var e,t,n;return this.length=_.reduce(this.leaves.toArray(),function(e,t){return t.length+e},0),this.trailingNewline&&(this.length+=1),this.outerHTML=this.node.outerHTML,this.formats={},n=Scribe.Utils.getFormatForContainer(this.node),e=n[0],t=n[1],e!=null&&(this.formats[e]=t),this.setDirty(!1),this.delta=this.toDelta()},t.prototype.setDirty=function(e){return e==null&&(e=!0),e?this.node.classList.add(Scribe.Line.DIRTY_CLASS):this.node.classList.remove(Scribe.Line.DIRTY_CLASS)},t.prototype.splitContents=function(e){var t,n,r;this.setDirty(),n=Scribe.Utils.getChildAtOffset(this.node,e),t=n[0],e=n[1];if(this.node.tagName==="OL"||this.node.tagName==="UL")r=Scribe.Utils.getChildAtOffset(t,e),t=r[0],e=r[1];return Scribe.DOM.splitNode(t,e)},t.prototype.toDelta=function(){var e,t;return t=_.map(this.leaves.toArray(),function(e){return new Tandem.InsertOp(e.text,e.getFormats(!0))}),this.trailingNewline&&t.push(new Tandem.InsertOp("\n",this.formats)),e=new Tandem.Delta(0,this.length,t),e},t}(LinkedList.Node),window.Scribe||(window.Scribe={}),window.Scribe.Line=e}.call(this),function(){var e;e={applyRules:function(e){var t=this;return Scribe.DOM.traversePreorder(e,0,function(e,t){var n;return e.nodeType===e.ELEMENT_NODE&&(n=Scribe.Constants.LINE_RULES[e.tagName],n!=null?_.each(n,function(t,n){switch(n){case"rename":return e=Scribe.DOM.switchTag(e,t)}}):e=Scribe.DOM.unwrap(e)),e})},breakBlocks:function(e){return this.groupBlocks(e),_.each(e.querySelectorAll(Scribe.Line.BREAK_TAGS.join(", ")),function(t){return t.tagName!=="BR"&&(t=Scribe.DOM.switchTag(t,"br")),Scribe.Normalizer.normalizeBreak(t,e)}),_.each(e.querySelectorAll(Scribe.Line.BLOCK_TAGS.join(", ")),function(e){if(e.tagName!=="DIV")return e=Scribe.DOM.switchTag(e,"div")}),_.each(e.childNodes,function(e){return Scribe.Normalizer.breakLine(e)})},breakLine:function(e){if(e.childNodes.length===1&&e.firstChild.tagName==="BR")return;return Scribe.DOM.traversePostorder(e,function(t){var n;if(Scribe.Utils.isBlock(t)){t.tagName!=="DIV"&&(t=Scribe.DOM.switchTag(t,"div"));if(t.nextSibling!=null){n=e.ownerDocument.createElement("div"),e.parentNode.insertBefore(n,e.nextSibling);while(t.nextSibling!=null)n.appendChild(t.nextSibling);Scribe.Normalizer.breakLine(n)}return Scribe.DOM.unwrap(t)}return t})},groupBlocks:function(e){var t,n,r,i;t=e.firstChild,i=[];while(t!=null)if(Scribe.Utils.isBlock(t))i.push(t=t.nextSibling);else{n=e.ownerDocument.createElement("div"),e.insertBefore(n,t);while(t!=null&&!Scribe.Utils.isBlock(t))r=t.nextSibling,n.appendChild(t),t=r;i.push(t=n)}return i},mergeAdjacent:function(e){return Scribe.DOM.traversePreorder(e,0,function(e){var t,n,r,i,s,o,u;return e.nodeType===e.ELEMENT_NODE&&!Scribe.Line.isLineNode(e)&&Scribe.Utils.canModify(e)&&(t=e.nextSibling,(t!=null?t.tagName:void 0)===e.tagName&&e.tagName!=="LI"&&Scribe.Utils.canModify(e)&&Scribe.Utils.canModify(t)&&(o=Scribe.Utils.getFormatForContainer(e),i=o[0],s=o[1],u=Scribe.Utils.getFormatForContainer(t),n=u[0],r=u[1],i===n&&s===r&&(e=Scribe.DOM.mergeNodes(e,t)))),e})},normalizeBreak:function(e,t){if(e===t)return;if(e.previousSibling!=null)return e.nextSibling!=null&&Scribe.DOM.splitAfter(e,t),e.parentNode.removeChild(e);if(e.nextSibling!=null){if(Scribe.DOM.splitAfter(e,t))return Scribe.Normalizer.normalizeBreak(e,t)}else if(e.parentNode!==t&&e.parentNode.parentNode!==t)return Scribe.DOM.unwrap(e.parentNode),Scribe.Normalizer.normalizeBreak(e,t)},normalizeDoc:function(e){return e.firstChild||e.appendChild(e.ownerDocument.createElement("div")),Scribe.Normalizer.breakBlocks(e),_.each(Scribe.DOM.toNodeArray(e.childNodes),function(e){return Scribe.Normalizer.normalizeLine(e),Scribe.Normalizer.optimizeLine(e)})},normalizeLine:function(e){if(e.childNodes.length===1&&e.firstChild.tagName==="BR")return;return this.applyRules(e),this.removeNoBreak(e),this.requireLeaf(e),this.wrapText(e)},optimizeLine:function(e){if(e.childNodes.length===1&&e.firstChild.tagName==="BR")return;return this.mergeAdjacent(e),this.removeRedundant(e),this.wrapText(e)},requireLeaf:function(e){if(!(Scribe.DOM.getChildNodes(e).length>1)){if(e.tagName==="OL"||e.tagName==="UL")e.appendChild(e.ownerDocument.createElement("li")),e=e.firstChild;return e.appendChild(e.ownerDocument.createElement("br"))}},removeNoBreak:function(e){var t=this;return Scribe.DOM.traversePreorder(e,0,function(e){return e.nodeType===e.TEXT_NODE&&(e.textContent=e.textContent.split(Scribe.Constants.NOBREAK_SPACE).join("")),e})},removeRedundant:function(e){var t,n,r=this;return n=_.uniqueId("_scribeFormats"),e[n]={},t=function(t){var r,i,s;if(t.nodeType===t.ELEMENT_NODE&&Scribe.Utils.canModify(t)){if(Scribe.Utils.getNodeLength(t)===0)return t.tagName!=="BR"||Scribe.DOM.getChildNodes(t.parentNode).length>1;s=Scribe.Utils.getFormatForContainer(t),r=s[0],i=s[1];if(r!=null)return t.parentNode[n][r]!=null;if(t.tagName==="SPAN"){if(t.childNodes.length===0||!_.any(t.childNodes,function(e){return e.nodeType!==e.ELEMENT_NODE}))return!0;if(t.previousSibling===null&&t.nextSibling===null&&t.parentNode!==e&&t.parentNode.tagName!=="LI")return!0}}return!1},Scribe.DOM.traversePreorder(e,0,function(e){var r,i,s;return t(e)&&(e=Scribe.DOM.unwrap(e)),e!=null&&(e[n]=_.clone(e.parentNode[n]),s=Scribe.Utils.getFormatForContainer(e),r=s[0],i=s[1],r!=null&&(e[n][r]=i)),e}),delete e[n],Scribe.DOM.traversePreorder(e,0,function(e){return delete e[n],e})},wrapText:function(e){var t=this;return Scribe.DOM.traversePreorder(e,0,function(t){var n;return t.normalize(),t.nodeType===t.TEXT_NODE&&(t.nextSibling!=null||t.previousSibling!=null||t.parentNode===e||t.parentNode.tagName==="LI")&&(n=t.ownerDocument.createElement("span"),Scribe.DOM.wrap(n,t),t=n),t})}},window.Scribe||(window.Scribe={}),window.Scribe.Normalizer=e}.call(this),function(){var e;e=function(){function e(e){this.editor=e,this.container=this.editor.root.ownerDocument.createElement("div"),this.container.id="paste-container",this.container.setAttribute("contenteditable",!0),this.editor.renderer.addStyles({"#paste-container":{left:"-10000px",position:"fixed",top:"50%"}}),this.editor.root.parentNode.appendChild(this.container),this.initListeners()}return e.prototype.initListeners=function(){var e=this;return this.editor.root.addEventListener("paste",function(){var t,n;e.editor.selection.deleteRange(),n=e.editor.getSelection();if(n==null)return;return t=e.editor.getLength(),e.container.innerHTML="",e.container.focus(),_.defer(function(){var r,i,s,o,u;return Scribe.Utils.removeExternal(e.container),Scribe.Utils.removeStyles(e.container),i=new Scribe.Document(e.container),s=i.lines.last,s.deleteText(s.length-1,1),r=i.toDelta(),n.start.index>0&&r.ops.unshift(new Tandem.RetainOp(0,n.start.index)),n.start.index<t&&r.ops.push(new Tandem.RetainOp(n.start.index,t)),r.endLength+=t,r.startLength=t,u=e.editor.doc.toDelta(),e.editor.applyDelta(r,!1),o=Math.max(0,e.editor.getLength()-t),e.editor.setSelection(new Scribe.Range(e.editor,n.start.index+o,n.start.index+o))})})},e}(),window.Scribe||(window.Scribe={}),window.Scribe.PasteManager=e}.call(this),function(){var e;e=function(){function e(e,t,n){var r;this.editor=e,this.leafNode=t,this.offset=n,_.isNumber(this.leafNode)?(this.offset=this.index=this.leafNode,this.leafNode=this.editor.root.firstChild):this.index=Scribe.Position.getIndex(this.leafNode,this.offset),r=Scribe.Position.findLeafNode(this.editor,this.leafNode,this.offset),this.leafNode=r[0],this.offset=r[1]}return e.findDeepestNode=function(e,t,n){var r,i;return r=Scribe.Line.isLineNode(t),i=Scribe.Utils.getNodeLength(t),r&&n<i?Scribe.Position.findDeepestNode(e,t.firstChild,Math.min(n,i)):n<i?t.firstChild!=null?Scribe.Position.findDeepestNode(e,t.firstChild,n):[t,n]:t.nextSibling!=null?(n-=i,Scribe.Position.findDeepestNode(e,t.nextSibling,n)):t.lastChild!=null?Scribe.Position.findDeepestNode(e,t.lastChild,Scribe.Utils.getNodeLength(t.lastChild)):[t,n]},e.findLeafNode=function(e,t,n){var r;return r=Scribe.Position.findDeepestNode(e,t,n),t=r[0],n=r[1],t.nodeType===t.TEXT_NODE&&(n=Scribe.Position.getIndex(t,n,t.parentNode),t=t.parentNode),[t,n]},e.getIndex=function(e,t,n){n==null&&(n=null);while(e!==n&&(e!=null?e.id:void 0)!==Scribe.Editor.CONTAINER_ID){while(e.previousSibling!=null)e=e.previousSibling,t+=Scribe.Utils.getNodeLength(e);e=e.parentNode}return t},e.prototype.getLeaf=function(){return this.leaf!=null?this.leaf:(this.leaf=this.editor.doc.findLeaf(this.leafNode),this.leaf)},e}(),window.Scribe||(window.Scribe={}),window.Scribe.Position=e}.call(this),function(){var e;rangy.init(),e=function(){function e(e,t,n){this.editor=e,this.start=t,this.end=n,_.isNumber(this.start)&&(this.start=new Scribe.Position(this.editor,this.start)),_.isNumber(this.end)&&(this.end=new Scribe.Position(this.editor,this.end))}return e.prototype.equals=function(e){return e==null?!1:e.start.leafNode===this.start.leafNode&&e.end.leafNode===this.end.leafNode&&e.start.offset===this.start.offset&&e.end.offset===this.end.offset},e.prototype.getFormats=function(){var e,t,n,r;return this.formats!=null?this.formats:(r=this.start.getLeaf(),e=this.end.getLeaf(),r==null||e==null?{}:this.isCollapsed()?r.getFormats():(n=this.getLeaves(),n.length>1&&this.end.offset===0&&n.pop(),n.length>1&&this.start.offset===n[0].length&&n.splice(0,1),t=n.length>0?n[0].getFormats():{},_.all(n,function(e){var n;return n=e.getFormats(),_.each(t,function(e,r){if(!n[r])return delete t[r];if(n[r]!==e)return _.isArray(e)||(t[r]=[e]),t[r].push(n[r])}),_.keys(t).length>0}),_.each(t,function(e,n){if(_.isArray(e))return t[n]=_.uniq(e)}),this.formats=t,t))},e.prototype.getLeafNodes=function(){var e,t;return t=this.getRangy(),t.collapsed?[this.start.leafNode]:(e=_.map(t.getNodes([3]),function(e){return e.parentNode}),(e[e.length-1]!==this.end.leafNode||this.end.offset===0)&&e.pop(),e)},e.prototype.getLeaves=function(){var e,t;return t=new Scribe.LeafIterator(this.start.getLeaf(),this.end.getLeaf()),e=t.toArray(),e},e.prototype.getLineNodes=function(){var e,t,n;n=this.editor.doc.findLineNode(this.start.leafNode),e=this.editor.doc.findLineNode(this.end.leafNode);if(n===e)return[n];t=[];while(n!==e)t.push(n),n=n.nextSibling;return t.push(e),t},e.prototype.getLines=function(){var e=this;return _.map(this.getLineNodes(),function(t){return e.editor.doc.findLine(t)})},e.prototype.getRangy=function(){var e;return e=rangy.createRangyRange(this.editor.contentWindow),this.start.leafNode.nodeName!=="BR"&&this.start.leafNode.firstChild!=null?e.setStart(this.start.leafNode.firstChild,this.start.offset):e.setStart(this.start.leafNode,0),this.end.leafNode.nodeName!=="BR"&&this.end.leafNode.firstChild!=null?e.setEnd(this.end.leafNode.firstChild,this.end.offset):e.setEnd(this.end.leafNode,0),e},e.prototype.getText=function(){var e,t,n=this;return e=this.getLeaves(),e.length===0?"":(t=e[0].line,_.map(e,function(e){var r;return r=e.text,e===n.end.getLeaf()&&(r=r.substring(0,n.end.offset)),e===n.start.getLeaf()&&(r=r.substring(n.start.offset)),t!==e.line&&(r="\n"+r,t=e.line),r}).join(""))},e.prototype.isCollapsed=function(){return this.start.leafNode===this.end.leafNode&&this.start.offset===this.end.offset},e}(),window.Scribe||(window.Scribe={}),window.Scribe.Range=e}.call(this),function(){var e;e=function(){function e(e,t){this.container=e,this.options=_.extend(Scribe.Renderer.DEFAULTS,t),this.createFrame()}return e.DEFAULTS={keepHTML:!1},e.DEFAULT_STYLES={".editor":{bottom:"10px","font-family":"'Helvetica', 'Arial', san-serif","font-size":"13px",left:"15px","line-height":"15px",outline:"none",position:"absolute",right:"15px","tab-size":"4",top:"10px","white-space":"pre-wrap"},html:{height:"100%"},body:{cursor:"text",height:"100%",margin:"0px",padding:"0px"},".line:last-child":{"padding-bottom":"10px"},a:{"text-decoration":"underline"},b:{"font-weight":"bold"},i:{"font-style":"italic"},s:{"text-decoration":"line-through"},u:{"text-decoration":"underline"},ol:{margin:"0px",padding:"0px"},ul:{"list-style-type":"disc",margin:"0px",padding:"0px"},"ol.indent-1":{"list-style-type":"decimal"},"ol.indent-2":{"list-style-type":"lower-alpha"},"ol.indent-3":{"list-style-type":"lower-roman"},"ol.indent-4":{"list-style-type":"decimal"},"ol.indent-5":{"list-style-type":"lower-alpha"},"ol.indent-6":{"list-style-type":"lower-roman"},"ol.indent-7":{"list-style-type":"decimal"},"ol.indent-8":{"list-style-type":"lower-alpha"},"ol.indent-9":{"list-style-type":"lower-roman"},".background-black":{"background-color":"black"},".background-red":{"background-color":"red"},".background-orange":{"background-color":"orange"},".background-yellow":{"background-color":"yellow"},".background-green":{"background-color":"green"},".background-blue":{"background-color":"blue"},".background-purple":{"background-color":"purple"},".color-white":{color:"white"},".color-red":{color:"red"},".color-orange":{color:"orange"},".color-yellow":{color:"yellow"},".color-green":{color:"green"},".color-blue":{color:"blue"},".color-purple":{color:"purple"},".family-monospace":{"font-family":"'Courier New', monospace"},".family-serif":{"font-family":"'Times New Roman', serif"},".size-huge":{"font-size":"32px","line-height":"36px"},".size-large":{"font-size":"18px","line-height":"22px"},".size-small":{"font-size":"10px","line-height":"12px"},".indent-1":{"margin-left":"2em"},".indent-2":{"margin-left":"4em"},".indent-3":{"margin-left":"6em"},".indent-4":{"margin-left":"8em"},".indent-5":{"margin-left":"10em"},".indent-6":{"margin-left":"12em"},".indent-7":{"margin-left":"14em"},".indent-8":{"margin-left":"16em"},".indent-9":{"margin-left":"18em"}},e.objToCss=function(e){return _.map(e,function(e,t){var n;return n=_.map(e,function(e,t){return""+t+": "+e+";"}).join(" "),""+t+" { "+n+" }"}).join("\n")},e.prototype.addStyles=function(e){var t,n,r,i;return n=this.iframe.contentWindow.document,r=n.getElementsByTagName("head")[0],i=n.createElement("style"),i.type="text/css",t=Scribe.Renderer.objToCss(e),i.styleSheet!=null?i.styleSheet.cssText=t:i.appendChild(n.createTextNode(t)),r.appendChild(i)},e.prototype.createFrame=function(){var e,t,n,r;n=this.container.innerHTML,this.container.innerHTML="",this.iframe=this.container.ownerDocument.createElement("iframe"),this.iframe.frameborder=0,this.iframe.src="javascript:;",this.iframe.height=this.iframe.width="100%",this.container.appendChild(this.iframe),t=this.iframe.contentWindow.document,r=_.map(this.options.styles,function(e,t){var n;return n=Scribe.Renderer.DEFAULT_STYLES[t]||{},_.extend(n,e)}),r=_.extend(Scribe.Renderer.DEFAULT_STYLES,r),this.addStyles(r),e=t.createElement("div"),e.id=Scribe.Editor.CONTAINER_ID,e.classList.add("editor"),t.body.appendChild(e);if(this.options.keepHTML)return e.innerHTML=n},e}(),window.Scribe||(window.Scribe={}),window.Scribe.Renderer=e}.call(this),function(){var e;e=function(){function e(e){this.editor=e,this.range=null,this.initListeners()}return e.prototype.initListeners=function(){var e,t,n=this;return e=function(){return n.update()},t=function(t){if(Scribe.Keyboard.KEYS.LEFT<=t.which&&t.which<=Scribe.Keyboard.KEYS.DOWN)return e()},this.editor.root.addEventListener("keyup",t),this.editor.root.addEventListener("mouseup",e)},e.prototype.format=function(e,t){var n,r,i;this.update();if(!this.range)return;return i=this.range.start.index,n=this.range.end.index,r=this.range.getFormats(),n>i&&this.editor.formatAt(i,n-i,e,t),r[e]=t,this.range.formats=r,this.editor.emit(Scribe.Editor.events.SELECTION_CHANGE,this.range),this.setRange(new Scribe.Range(this.editor,i,n))},e.prototype.deleteRange=function(){return this.update(),this.range.isCollapsed()?!1:(this.editor.deleteAt(this.range.start.index,this.range.end.index-this.range.start.index),this.update(),this.range)},e.prototype.getNative=function(){var e,t,n,r,i,s,o,u;return i=rangy.getSelection(this.editor.contentWindow),s=window.getSelection(),i.anchorNode==null||i.focusNode==null?null:(i.isBackwards()?(u=[i.anchorNode,i.anchorOffset,i.focusNode,i.focusOffset],n=u[0],r=u[1],e=u[2],t=u[3]):(o=[i.anchorNode,i.anchorOffset,i.focusNode,i.focusOffset],e=o[0],t=o[1],n=o[2],r=o[3]),{anchorNode:e,anchorOffset:t,focusNode:n,focusOffset:r})},e.prototype.getRange=function(){var e,t,n;return t=this.getNative(),t==null?null:(n=new Scribe.Position(this.editor,t.anchorNode,t.anchorOffset),e=new Scribe.Position(this.editor,t.focusNode,t.focusOffset),new Scribe.Range(this.editor,n,e))},e.prototype.preserve=function(e){var t;return this.range!=null?(t=this.save(),e.call(null),this.restore(t)):e.call(null)},e.prototype.restore=function(e){return rangy.restoreSelection(e,!1),this.update(!0)},e.prototype.save=function(){var e;return e=rangy.saveSelection(this.editor.contentWindow),_.each(e.rangeInfos,function(e){return _.each([e.startMarkerId,e.endMarkerId,e.markerId],function(t){var n;n=e.document.getElementById(t);if((n!=null?n.classList:void 0)!=null)return n.classList.add(Scribe.Constants.SPECIAL_CLASSES.EXTERNAL)})}),e},e.prototype.setRange=function(e,t){var n,r;this.range=e,t==null&&(t=!1),n=rangy.getSelection(this.editor.contentWindow),this.range!=null?(r=this.range.getRangy(),n.setSingleRange(r)):n.removeAllRanges();if(!t)return this.editor.emit(Scribe.Editor.events.SELECTION_CHANGE,this.range)},e.prototype.setRangeNative=function(e){var t,n;return n=rangy.getSelection(this.editor.contentWindow),t=rangy.createRangyRange(this.editor.contentWindow),t.setStart(e.anchorNode,e.anchorOffset),t.setEnd(e.focusNode,e.focusOffset),n.setSingleRange(t)},e.prototype.update=function(e){var t,n;e==null&&(e=!1),t=this.getRange();if(t!==this.range&&((n=this.range)!=null?!n.equals(t):!void 0))return e||this.editor.emit(Scribe.Editor.events.SELECTION_CHANGE,t),this.range=t},e}(),window.Scribe||(window.Scribe={}),window.Scribe.Selection=e}.call(this),function(){var e,t,n,r,i,s={}.hasOwnProperty,o=function(e,t){function r(){this.constructor=e}for(var n in t)s.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};t=function(){var e=this;return _.each(Scribe.Toolbar.BUTTON_FORMATS,function(t){var n;n=e.container.querySelector("."+t);if(n==null)return;return n.addEventListener("click",function(){var r;return r=!n.classList.contains("active"),e.editor.selection.format(t,r),e.emit(Scribe.Toolbar.events.FORMAT,t,r)})})},n=function(){var e,t=this;e=this.container.querySelector(".link");if(e==null)return;return e.addEventListener("click",function(){var n,r;return r=!1,e.classList.contains("active")||(n=t.editor.selection.getRange(),r=n.getText()),t.editor.selection.format("link",r),t.emit(Scribe.Toolbar.events.FORMAT,"link",r)})},r=function(){var e=this;return _.each(Scribe.Toolbar.SELECT_FORMATS,function(t){var n;n=e.container.querySelector("."+t);if(n==null)return;return n.addEventListener("change",function(){var r;return r=n.options[n.selectedIndex].value,e.editor.selection.format(t,r),e.emit(Scribe.Toolbar.events.FORMAT,t,r)})})},i=function(){var e=this;return this.editor.on(Scribe.Editor.events.SELECTION_CHANGE,function(t){var n;return n=t.getFormats(),_.each(e.container.querySelectorAll(".active"),function(e){return e.classList.remove("active")}),_.each(n,function(t,n){var r;if(t!=null){r=e.container.querySelector("."+n);if(r==null)return;return r.tagName==="SELECT"?(_.isArray(t)&&(t=""),r.value=t):r.classList.add("active")}})})},e=function(e){function s(e,s){this.container=e,this.editor=s,_.isString(this.container)&&(this.container=document.getElementById(this.container)),t.call(this),n.call(this),r.call(this),i.call(this)}return o(s,e),s.BUTTON_FORMATS=["bold","italic","strike","underline","bullet","list","indent","outdent"],s.SELECT_FORMATS=["background","color","family","size"],s.events={FORMAT:"format"},s}(EventEmitter2),window.Scribe||(window.Scribe={}),window.Scribe.Toolbar=e}.call(this),function(){var e;e=function(){function e(e,t){this.editor=e,t==null&&(t={}),this.undoStack=[],this.redoStack=[],this.options=_.extend(Scribe.UndoManager.DEFAULTS,t),this.lastRecorded=0,this.initListeners()}return e.DEFAULTS={delay:1e3},e.computeUndo=function(e,t){var n,r,i,s;return r=i=0,s=[],_.each(e.ops,function(e){var n,o,u;return Tandem.Delta.isInsert(e)?i+=e.getLength():Tandem.Delta.isRetain(e)?(u=r+i,e.start>r&&(o=e.start-r,n=t.getOpsAt(r,o),s=s.concat(n),i-=o),s.push(new Tandem.RetainOp(u,u+e.getLength(),e.attributes)),r=e.end):console.error("Unrecognized type in op",e)}),e.endLength<e.startLength+i&&(n=t.getOpsAt(e.endLength-i,e.startLength-e.endLength+i),s=s.concat(n)),new Tandem.Delta(e.endLength,e.startLength,s)},e.getLastChangeIndex=function(e){var t,n,r;return n=t=r=0,_.each(e.ops,function(e){if(Tandem.Delta.isInsert(e))return r+=e.getLength(),n=t+r;if(Tandem.Delta.isRetain(e))return e.start>t&&(n=t+r,r-=e.start-t),t=e.end}),e.endLength<e.startLength+r&&(n=e.endLength),n},e.prototype.initListeners=function(){var e=this;return this.editor.keyboard.addHotkey(Scribe.Keyboard.HOTKEYS.UNDO,function(){return e.undo()}),this.editor.keyboard.addHotkey(Scribe.Keyboard.HOTKEYS.REDO,function(){return e.redo()})},e.prototype.record=function(e,t){var n,r,i;if(e.isIdentity(e))return;return this.redoStack=[],i=Scribe.UndoManager.computeUndo(e,t),r=(new Date).getTime(),this.lastRecorded+this.options.delay>r&&this.undoStack.length>0?(n=this.undoStack.pop(),i=i.compose(n.undo.delta),e=n.redo.delta.compose(e)):this.lastRecorded=r,this.undoStack.push({undo:{cursor:Scribe.UndoManager.getLastChangeIndex(i),delta:i},redo:{cursor:Scribe.UndoManager.getLastChangeIndex(e),delta:e}})},e.prototype.redo=function(){var e;if(this.redoStack.length>0)return e=this.redoStack.pop(),this.editor.applyDelta(e.redo.delta),this.editor.setSelection(new Scribe.Range(this.editor,e.redo.cursor,e.redo.cursor)),this.undoStack.push(e)},e.prototype.undo=function(){var e;if(this.undoStack.length>0)return e=this.undoStack.pop(),this.editor.applyDelta(e.undo.delta),this.editor.setSelection(new Scribe.Range(this.editor,e.undo.cursor,e.undo.cursor)),this.redoStack.push(e)},e}(),window.Scribe||(window.Scribe={}),window.Scribe.UndoManager=e}.call(this),function(){var e;e={canModify:function(e){return!e.classList.contains(Scribe.Constants.SPECIAL_CLASSES.ATOMIC)&&!e.classList.contains(Scribe.Constants.SPECIAL_CLASSES.EXTERNAL)},canRemove:function(e){return!e.classList.contains(Scribe.Constants.SPECIAL_CLASSES.EXTERNAL)},cleanHtml:function(e,t){return t==null&&(t=!1),e=e.replace(/^\s\s*/,"").replace(/\s\s*$/,""),e=e.replace(/>\s\s+</gi,"><"),t!==!0&&(e=e.replace(/\ (class|id)="[a-z0-9\-_]+"/gi,"")),e=e.replace(/<br><\/br>/,"<br>"),e},createContainerForFormat:function(e,t,n){var r,i;switch(t){case"bold":return e.createElement("b");case"italic":return e.createElement("i");case"strike":return e.createElement("s");case"underline":return e.createElement("u");case"link":return r=e.createElement("a"),n.match(/https?:\/\//)||(n="https://"+n),r.href=n,r.protocol!=="http:"&&r.protocol!=="https:"&&(r.href="about:blank"),r.title=r.href,r;default:return i=e.createElement("span"),i.classList.add(""+t+"-"+n),i}},cloneAncestors:function(e,t){var n,r;n=e.cloneNode(!1),e=e.parentNode;while(e!=null&&e!==t)r=e.cloneNode(!1),r.appendChild(n),n=r,e=e.parentNode;return n},findAncestor:function(e,t){while(e!=null&&!t(e))e=e.parentNode;return e},getFormatDefault:function(e){return Scribe.Constants.DEFAULT_LEAF_FORMATS[e]||!1},getFormatForContainer:function(e){var t,n;switch(e.tagName){case"A":return["link",e.getAttribute("href")];case"B":return["bold",!0];case"I":return["italic",!0];case"S":return["strike",!0];case"U":return["underline",!0];case"OL":return["list",Scribe.Utils.getIndent(e)];case"UL":return["bullet",Scribe.Utils.getIndent(e)];case"DIV":return n=Scribe.Utils.getIndent(e),n>0?["indent",n]:[];case"SPAN":return t=[],_.any(e.classList,function(e){var n,r,i;r=e.split("-");if(r.length>1){n=r[0],i=r.slice(1).join("-");if(Scribe.Constants.SPAN_FORMATS[n]!=null)return t=[n,i],!0}return!1}),t;default:return[]}},getChildAtOffset:function(e,t){var n,r;n=e.firstChild,r=Scribe.Utils.getNodeLength(n);while(n!=null){if(t<r)break;t-=r,n=n.nextSibling,r=Scribe.Utils.getNodeLength(n)}return n==null&&(n=e.lastChild,t=Scribe.Utils.getNodeLength(n)),[n,t]},getIndent:function(e){var t;return t=0,_.any(e.classList,function(e){return e.substring(0,Scribe.Document.INDENT_PREFIX.length)===Scribe.Document.INDENT_PREFIX?(t=parseInt(e.substring(Scribe.Document.INDENT_PREFIX.length)),!0):!1}),t},getNodeLength:function(e){var t,n;return e==null?0:e.nodeType===e.ELEMENT_NODE?e.classList.contains(Scribe.Constants.SPECIAL_CLASSES.EXTERNAL)?0:(t=e.querySelectorAll("."+Scribe.Constants.SPECIAL_CLASSES.EXTERNAL),n=_.reduce(t,function(e,t){return e-t.textContent.length},e.textContent.length),n+(Scribe.Line.isLineNode(e)?1:0)):e.nodeType===e.TEXT_NODE?e.textContent.length:0},groupBlocks:function(e){var t,n,r,i;t=e.firstChild,n=null,i=[];while(t!=null)r=t.nextSibling,Scribe.Utils.isBlock(t)?n!=null&&(n=null):(n==null&&(n=e.ownerDocument.createElement("div"),t.parentNode.insertBefore(n,t)),n.appendChild(t)),i.push(t=r);return i},isBlock:function(e){return _.indexOf(Scribe.Line.BLOCK_TAGS,e.tagName)>-1},isTextNodeParent:function(e){return e.childNodes.length===1&&e.firstChild.nodeType===e.TEXT_NODE},insertExternal:function(e,t){return e.leafNode.lastChild!=null?e.leafNode.lastChild.nodeType===e.leafNode.TEXT_NODE?(e.leafNode.lastChild.splitText(e.offset),e.leafNode.insertBefore(t,e.leafNode.lastChild)):e.leafNode.parentNode.insertBefore(t,e.leafNode):(e.offset!==0&&console.warn("offset is not 0",e.offset),e.leafNode.parentNode.insertBefore(t,e.leafNode))},moveExternal:function(e,t,n){var r;return r=_.clone(e.querySelectorAll("."+Scribe.Constants.SPECIAL_CLASSES.EXTERNAL)),_.each(r,function(e){return t.insertBefore(e,n)})},removeFormatFromSubtree:function(e,t){var n,r,i,s,o,u;return n=_.clone(e.childNodes),r=Scribe.Utils.getFormatForContainer(e),u=Scribe.Utils.getFormatForContainer(e),i=u[0],o=u[1],s=e,i===t&&(s=Scribe.DOM.unwrap(e)),_.each(n,function(e){return Scribe.Utils.removeFormatFromSubtree(e,t)}),s},removeExternal:function(e){var t;return t=_.clone(e.querySelectorAll("."+Scribe.Constants.SPECIAL_CLASSES.EXTERNAL)),_.each(t,function(e){if(e.parentNode!=null)return e.parentNode.removeChild(e)})},removeNode:function(e){var t,n;if(e.parentNode==null)return;if(Scribe.Line.isLineNode(e)){n=e.previousSibling,t=e.nextSibling;for(;;){if(Scribe.Line.isLineNode(n)){Scribe.Utils.moveExternal(e,n,null);break}if(Scribe.Line.isLineNode(t)){Scribe.Utils.moveExternal(e,t,t.firstChild);break}if(n==null&&t==null){console.warn("External nodes might have no where to go!"),Scribe.Utils.moveExternal(e,e.parentNode,e.nextSibling);break}n!=null&&(n=n.previousSibling),t!=null&&(t=t.nextSibling)}}else Scribe.Utils.moveExternal(e,e.parentNode,e.nextSibling);return e.parentNode.removeChild(e)},removeStyles:function(e){var t,n;t=e.ownerDocument.createTreeWalker(e,NodeFilter.SHOW_ELEMENT,null,!1),t.firstChild(),t.currentNode.removeAttribute("style"),n=[];while(t.nextNode())n.push(t.currentNode.removeAttribute("style"));return n},setIndent:function(e,t){_.each(_.clone(e.classList),function(t){if(t.substring(0,Scribe.Document.INDENT_PREFIX.length)===Scribe.Document.INDENT_PREFIX)return e.classList.remove(t)});if(t)return e.classList.add(Scribe.Document.INDENT_PREFIX+t)}},window.Scribe||(window.Scribe={}),window.Scribe.Utils=e}.call(this);